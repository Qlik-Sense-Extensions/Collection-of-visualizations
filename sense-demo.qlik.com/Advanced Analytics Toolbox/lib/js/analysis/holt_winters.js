"use strict";define(["../chart/line_chart","../chart/datatables","../util/utils","ng!$q","../../vendor/d3-format.min"],function(e,a,t,r,o){return{createCube:function(e,a){var r=a.layout,o=t.validateDimension(r.props.dimensions[0]),s=[{qNullSuppression:!0,qDef:{qFieldDefs:[o]}}],i=t.validateMeasure(r.props.measures[0]),l="";r.props.frequency>0&&(l=",frequency="+r.props.frequency);var p="";r.props.autoHoltWinters||(p=",alpha="+r.props.holtWintersAlpha+",beta="+r.props.holtWintersBeta+",gamma="+r.props.holtWintersGamma),t.displayDebugModeMessage(r.props.debugMode);var n=t.getDebugSaveDatasetScript(r.props.debugMode,"debug_timeseries_forecast.rda"),d="R.ScriptEvalExStr('N', '"+n+" library(jsonlite);library(dplyr);library(forecast);data<-ts(na.omit(q$Measure) "+l+');\n      fit<-HoltWinters(data, seasonal="'+r.props.seasonal+'" '+p+");\n      res<-forecast(fit, level="+r.props.confidenceLevel+", h="+r.props.forecastingPeriods+");\n      json<-toJSON(list(as.double(res$mean),as.double(res$upper),as.double(res$lower),list(fit$alpha, fit$beta, fit$gamma, fit$coefficients))); json;', "+i+" as Measure)";t.displayRScriptsToConsole(r.props.debugMode,[d]);var u=[{qDef:{qDef:i}},{qDef:{qDef:d}},{qDef:{qLabel:"-",qDef:""}},{qDef:{qLabel:"-",qDef:""}},{qDef:{qLabel:"-",qDef:""}}];return a.backendApi.applyPatches([{qPath:"/qHyperCubeDef/qDimensions",qOp:"replace",qValue:JSON.stringify(s)},{qPath:"/qHyperCubeDef/qMeasures",qOp:"replace",qValue:JSON.stringify(u)}],!1),a.patchApplied=!0,null},drawChart:function(o,s){var i=r.defer(),l=o.layout,p=[{qTop:0,qLeft:0,qWidth:6,qHeight:1500}];return o.backendApi.getData(p).then(function(r){if(0===r[0].qMatrix[0][1].qText.length||"-"==r[0].qMatrix[0][1].qText)t.displayConnectionError(o.extId);else{t.displayReturnedDatasetToConsole(l.props.debugMode,r[0]);var p=t.getDefaultPaletteColor(),n=JSON.parse(r[0].qMatrix[0][2].qText),d=n[0],u=n[1],m=n[2],h=n[3],c=h[0],f=h[1],b=h[2];if("undefined"==typeof o.layout.props.displayTable||0==o.layout.props.displayTable){var q={},y=r[0].qMatrix.length,g=[],x=[],v=[];$.each(r[0].qMatrix,function(e,a){g.push(a[0].qElemNumber),x.push(a[0].qText),v.push(a[1].qNum)}),q.elemNum=g,q.dim1=x,q.mea1=v;for(var D=new Array(y),M=new Array(y),w=new Array(y),N=0;N<l.props.forecastingPeriods;N++)q.dim1.push("+"+(N+1)),D.push(d[N]),M.push(u[N]),w.push(m[N]);q.mea2=D,q.mea3=M,q.mea4=w;var S=[{x:q.dim1,y:q.mea1,elemNum:q.elemNum,name:"Observed",mode:"lines+markers",fill:l.props.line,fillcolor:l.props.colors?"rgba("+p[3]+",0.3)":"rgba("+p[l.props.colorForMain]+",0.3)",marker:{color:l.props.colors?"rgba("+p[3]+",1)":"rgba("+p[l.props.colorForMain]+",1)",size:l.props.datapoints?l.props.pointRadius:1},line:{width:l.props.borderWidth}},{x:q.dim1,y:q.mea2,name:"Fit",mode:"lines+markers",marker:{color:l.props.colors?"rgba("+p[7]+",1)":"rgba("+p[l.props.colorForSub]+",1)",size:l.props.datapoints?l.props.pointRadius:1},line:{width:l.props.borderWidth}},{x:q.dim1,y:q.mea3,name:"Upper",fill:"tonexty",fillcolor:"rgba("+p[l.props.colorForSub]+",0.3)",type:"scatter",mode:"none"},{x:q.dim1,y:q.mea4,name:"Lower",fill:"tonexty",fillcolor:"rgba("+p[l.props.colorForSub]+",0.3)",type:"scatter",mode:"none"}],T={xaxis:{type:"category",title:o.layout.props.xLabelsAndTitle?o.layout.props.dimensions[0].label:"",showgrid:o.layout.props.xScale,side:o.layout.props.xAxisPosition}};l.props.displayHoltWintersParams?$(".advanced-analytics-toolsets-"+o.extId).html('\n                <div style="width:100%;height:5%;text-align:right;">alpha='+c+", beta="+f+", gamma="+b+'</div>\n                <div id="aat-chart-'+o.extId+'" style="width:100%;height:95%;"></div>\n              '):$(".advanced-analytics-toolsets-"+o.extId).html('<div id="aat-chart-'+o.extId+'" style="width:100%;height:100%;"></div>');var A=e.draw(o,S,"aat-chart-"+o.extId,T);e.setEvents(A,o,s)}else{var F=t.getLocale(o,0),L=t.getNumberFormat(o,0),P=(r[0].qMatrix.length,[]);$.each(r[0].qMatrix,function(e,a){P.push([a[0].qElemNumber,a[0].qText,F.format(L)(a[1].qNum).replace(/G/,"B"),"","",""])});for(var W=0;W<l.props.forecastingPeriods;W++)P.push(["","+"+(W+1),"",F.format(L)(d[W]).replace(/G/,"B"),F.format(L)(u[W]).replace(/G/,"B"),F.format(L)(m[W]).replace(/G/,"B")]);var C='\n              <table id="aat-table-'+o.extId+'" class="display">\n                <thead>\n                  <tr>\n                    <th>qElemNumber</th>\n                    <th>'+o.layout.props.dimensions[0].label+"</th>\n                    <th>"+o.layout.props.measures[0].label+"</th>\n                    <th>Fit</th>\n                    <th>Lower</th>\n                    <th>Upper</th>\n                  </tr>\n                </thead>\n                <tbody>\n                </tbody>\n              </table>";a.draw(s,o,"#aat-table-"+o.extId,P,C,null).then(function(e){a.setEvents(e,o,s)})}}return i.resolve()}),i.promise}}});
//# sourceMappingURL=../../maps/analysis/holt_winters.js.map
