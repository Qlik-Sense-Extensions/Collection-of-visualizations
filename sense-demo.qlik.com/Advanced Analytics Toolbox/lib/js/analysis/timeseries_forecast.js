"use strict";define(["../chart/line_chart","../chart/datatables","../util/utils","ng!$q","../../vendor/d3-format.min"],function(e,r,a,t,o){return{createCube:function(e,r){var t=r.layout,o=a.validateDimension(t.props.dimensions[0]),s=[{qNullSuppression:!0,qDef:{qFieldDefs:[o]}}],i=a.validateMeasure(t.props.measures[0]),p="";p=t.props.autoARIMA?"fit<-auto.arima(data);":"fit<-arima(data, order=c("+t.props.AROrder+","+t.props.DegreeOfDifferencing+","+t.props.MAOrder+")\n                      ,seasonal=list(order=c("+t.props.SeasonalAROrder+","+t.props.SeasonalDegreeOfDifferencing+","+t.props.SeasonalMAOrder+"), period="+t.props.frequency+"));";var l="";t.props.frequency>0&&(l=",frequency="+t.props.frequency),a.displayDebugModeMessage(t.props.debugMode);var n=a.getDebugSaveDatasetScript(t.props.debugMode,"debug_timeseries_forecast.rda"),d="R.ScriptEvalExStr('N', '"+n+" library(jsonlite);library(dplyr);library(forecast);data<-ts(na.omit(q$Measure) "+l+");"+p+"\n      res<-forecast(fit, level="+t.props.confidenceLevel+", h="+t.props.forecastingPeriods+");\n      json<-toJSON(list(as.double(res$mean),as.double(res$upper),as.double(res$lower),arimaorder(fit))); json;', "+i+" as Measure)";a.displayRScriptsToConsole(t.props.debugMode,[d]);var u=[{qDef:{qDef:i}},{qDef:{qDef:d}},{qDef:{qLabel:"-",qDef:""}},{qDef:{qLabel:"-",qDef:""}},{qDef:{qLabel:"-",qDef:""}}];return r.backendApi.applyPatches([{qPath:"/qHyperCubeDef/qDimensions",qOp:"replace",qValue:JSON.stringify(s)},{qPath:"/qHyperCubeDef/qMeasures",qOp:"replace",qValue:JSON.stringify(u)}],!1),r.patchApplied=!0,null},drawChart:function(o,s){var i=t.defer(),p=o.layout,l=[{qTop:0,qLeft:0,qWidth:6,qHeight:1500}];return o.backendApi.getData(l).then(function(t){if(0===t[0].qMatrix[0][1].qText.length||"-"==t[0].qMatrix[0][1].qText)a.displayConnectionError(o.extId);else{a.displayReturnedDatasetToConsole(p.props.debugMode,t[0]);var l=a.getDefaultPaletteColor(),n=JSON.parse(t[0].qMatrix[0][2].qText),d=n[0],u=n[1],m=n[2],c=n[3],h=p.props.limit;if("undefined"==typeof o.layout.props.displayTable||0==o.layout.props.displayTable){var f={},y=t[0].qMatrix.length,b=[],q=[],g=[];$.each(t[0].qMatrix,function(e,r){b.push(r[0].qElemNumber),q.push(r[0].qText),g.push(r[1].qNum)}),f.elemNum=b,f.dim1=q,f.mea1=g;for(var x=new Array(y),v=new Array(y),D=new Array(y),M=new Array(y),A=0;A<p.props.forecastingPeriods;A++)f.dim1.push("+"+(A+1)),x.push(d[A]),v.push(u[A]),D.push(m[A]),M.push(h);f.mea2=x,f.mea3=v,f.mea4=D,f.mea5=M;var w="";0<c.length&&c.length<=3?w="("+c[0]+","+c[1]+","+c[2]+")":c.length<=6?w="("+c[0]+","+c[1]+","+c[2]+")("+c[3]+","+c[4]+","+c[5]+")":6<c.length&&(w="("+c[0]+","+c[1]+","+c[2]+")("+c[3]+","+c[4]+","+c[5]+")["+c[6]+"]");var S=[{x:f.dim1,y:f.mea1,elemNum:f.elemNum,name:"Observed",mode:"lines+markers",fill:p.props.line,fillcolor:p.props.colors?"rgba("+l[3]+",0.3)":"rgba("+l[p.props.colorForMain]+",0.3)",marker:{color:p.props.colors?"rgba("+l[3]+",1)":"rgba("+l[p.props.colorForMain]+",1)",size:p.props.datapoints?p.props.pointRadius:1},line:{width:p.props.borderWidth}},{x:f.dim1,y:f.mea2,name:"Fit",mode:"lines+markers",marker:{color:p.props.colors?"rgba("+l[7]+",1)":"rgba("+l[p.props.colorForSub]+",1)",size:p.props.datapoints?p.props.pointRadius:1},line:{width:p.props.borderWidth}},{x:f.dim1,y:f.mea3,name:"Upper",fill:"tonexty",fillcolor:"rgba("+l[p.props.colorForSub]+",0.3)",type:"scatter",mode:"none"},{x:f.dim1,y:f.mea4,name:"Lower",fill:"tonexty",fillcolor:"rgba("+l[p.props.colorForSub]+",0.3)",type:"scatter",mode:"none"},{x:f.dim1,y:f.mea5,name:p.props.limitlabel,mode:"lines",marker:{color:"rgba("+l[p.props.limitcolor]+",1)",size:p.props.datapoints?p.props.pointRadius:1},line:{dash:p.props.limitstyle,width:p.props.limitwidth}}],N={xaxis:{type:"category",title:o.layout.props.xLabelsAndTitle?o.layout.props.dimensions[0].label:"",showgrid:o.layout.props.xScale,side:o.layout.props.xAxisPosition}};p.props.displayARIMAParams?$(".advanced-analytics-toolsets-"+o.extId).html('\n                <div style="width:100%;height:5%;text-align:right;">ARIMA'+w+'</div>\n                <div id="aat-chart-'+o.extId+'" style="width:100%;height:95%;"></div>\n              '):$(".advanced-analytics-toolsets-"+o.extId).html('<div id="aat-chart-'+o.extId+'" style="width:100%;height:100%;"></div>');var O=e.draw(o,S,"aat-chart-"+o.extId,N);e.setEvents(O,o,s)}else{var I=a.getLocale(o,0),R=a.getNumberFormat(o,0),T=(t[0].qMatrix.length,[]);$.each(t[0].qMatrix,function(e,r){T.push([r[0].qElemNumber,r[0].qText,I.format(R)(r[1].qNum).replace(/G/,"B"),"","",""])});for(var F=0;F<p.props.forecastingPeriods;F++)T.push(["","+"+(F+1),"",I.format(R)(d[F]).replace(/G/,"B"),I.format(R)(u[F]).replace(/G/,"B"),I.format(R)(m[F]).replace(/G/,"B")]);var L='\n              <table id="aat-table-'+o.extId+'" class="display">\n                <thead>\n                  <tr>\n                    <th>qElemNumber</th>\n                    <th>'+o.layout.props.dimensions[0].label+"</th>\n                    <th>"+o.layout.props.measures[0].label+"</th>\n                    <th>Fit</th>\n                    <th>Lower</th>\n                    <th>Upper</th>\n                  </tr>\n                </thead>\n                <tbody>\n                </tbody>\n              </table>";r.draw(s,o,"#aat-table-"+o.extId,T,L,null).then(function(e){r.setEvents(e,o,s)})}}return i.resolve()}),i.promise}}});
//# sourceMappingURL=../../maps/analysis/timeseries_forecast.js.map
