"use strict";define(["../chart/line_chart","../chart/datatables","../util/utils","ng!$q","../../vendor/d3-format.min"],function(e,r,t,o,a){return{createCube:function(e,r){var o=r.layout,a=t.validateDimension(o.props.dimensions[0]),s=[{qNullSuppression:!0,qDef:{qFieldDefs:[a],qSortCriterias:[{qSortByExpression:o.props.dimSort||!o.props.dimSortByExpression?0:o.props.dimSortByExpressionAsc,qSortByNumeric:o.props.dimSort?1:o.props.dimSortByNum?o.props.dimSortByNumAsc:0,qSortByAscii:o.props.dimSort||!o.props.dimSortByAlph?0:o.props.dimSortByAlphAsc,qExpression:{qv:o.props.dimSortByExpressionString}}]}}],p=t.validateMeasure(o.props.measures[0]),n='json<-toJSON(list(res[,1], res[,2], res[,3], coef(summary(lm_result))[,"Estimate"]));';o.props.extendLine&&(n="by<-q$Dimension[length(q$Dimension)]-q$Dimension[length(q$Dimension)-1]; from<-q$Dimension[length(q$Dimension)]+by;\n                    data<-seq(from=from, by=by, length.out="+o.props.extendDurations+'); newdata <-data.frame(Dimension=data); pred_res<-predict(lm_result,newdata, interval="'+o.props.interval+'", level='+o.props.confidenceLevel+');\n                    json<-toJSON(list(res[,1], res[,2], res[,3], coef(summary(lm_result))[,"Estimate"], pred_res[,1], pred_res[,2], pred_res[,3]));'),t.displayDebugModeMessage(o.props.debugMode);var i=t.getDebugSaveDatasetScript(o.props.debugMode,"debug_simple_linear_line.rda"),l="R.ScriptEvalExStr('NN','"+i+' library(jsonlite); lm_result <- lm(Measure~Dimension, data=q);res<-predict(lm_result, interval="'+o.props.interval+'", level='+o.props.confidenceLevel+");\n      "+n+" json;',"+a+" as Dimension, "+p+" as Measure)";t.displayRScriptsToConsole(o.props.debugMode,[l]);var d=[{qDef:{qDef:p}},{qDef:{qLabel:"Fit",qDef:l}},{qDef:{qLabel:"-",qDef:""}},{qDef:{qLabel:"-",qDef:""}},{qDef:{qLabel:"-",qDef:""}}];return r.backendApi.applyPatches([{qPath:"/qHyperCubeDef/qDimensions",qOp:"replace",qValue:JSON.stringify(s)},{qPath:"/qHyperCubeDef/qMeasures",qOp:"replace",qValue:JSON.stringify(d)}],!1),r.patchApplied=!0,null},drawChart:function(a,s){var p=o.defer(),n=a.layout,i=[{qTop:0,qLeft:0,qWidth:6,qHeight:1500}];return a.backendApi.getData(i).then(function(o){a.layout.qHyperCube.qMeasureInfo;if(0===o[0].qMatrix[0][1].qText.length||"-"==o[0].qMatrix[0][1].qText)t.displayConnectionError(a.extId);else{t.displayReturnedDatasetToConsole(n.props.debugMode,o[0]);var i=t.getDefaultPaletteColor(),l=JSON.parse(o[0].qMatrix[0][2].qText),d=l[0],m=l[1],u=l[2],c=l[3],q=l[4],f=l[5],y=l[6],h="y="+c[1]+"x";if(h+=c[0]<0?""+c[0]:"+"+c[0],"undefined"==typeof a.layout.props.displayTable||0==a.layout.props.displayTable){var b=[],x=[],g=[];if($.each(o[0].qMatrix,function(e,r){b.push(r[0].qElemNumber),x.push(r[0].qText),g.push(r[1].qNum)}),n.props.extendLine){$.merge(d,q),$.merge(m,f),$.merge(u,y);for(var v=0;v<n.props.extendDurations;v++)x.push("+"+(v+1)),g.push("")}var D=[{x:x,y:g,elemNum:b,name:"Observed",mode:"lines+markers",fill:n.props.line,fillcolor:n.props.colors?"rgba("+i[3]+",0.3)":"rgba("+i[n.props.colorForMain]+",0.3)",marker:{color:n.props.colors?"rgba("+i[3]+",1)":"rgba("+i[n.props.colorForMain]+",1)",size:n.props.datapoints?n.props.pointRadius:1},line:{width:n.props.borderWidth}},{x:x,y:d,name:"Fit",line:{color:"rgba("+i[n.props.colorForSub]+",1)"}},{x:x,y:m,name:"Lower",fill:"tonexty",fillcolor:"rgba("+i[n.props.colorForSub]+",0.3)",type:"scatter",mode:"none"},{x:x,y:u,name:"Upper",fill:"tonexty",fillcolor:"rgba("+i[n.props.colorForSub]+",0.3)",type:"scatter",mode:"none"}],S=Math.floor(x.length/2),M=x[S],N=d[S],B={annotations:[]};n.props.displayFormula&&B.annotations.push({x:M,y:N,text:h,xref:"x",yref:"y",ax:-30,ay:-40,showarrow:!0,arrowhead:3}),$(".advanced-analytics-toolsets-"+a.extId).html('<div id="aat-chart-'+a.extId+'" style="width:100%;height:100%;"></div>');var E=e.draw(a,D,"aat-chart-"+a.extId,B);e.setEvents(E,a,s)}else{var L=t.getLocale(a,0),_=t.getNumberFormat(a,0),w=[];if($.each(o[0].qMatrix,function(e,r){w.push([r[0].qElemNumber,r[0].qText,L.format(_)(r[1].qNum).replace(/G/,"B"),L.format(_)(d[e]).replace(/G/,"B"),L.format(_)(m[e]).replace(/G/,"B"),L.format(_)(u[e]).replace(/G/,"B")])}),n.props.extendLine)for(var F=0;F<n.props.forecastingPeriods;F++)w.push(["","+"+(F+1),"",L.format(_)(q[F]).replace(/G/,"B"),L.format(_)(f[F]).replace(/G/,"B"),L.format(_)(y[F]).replace(/G/,"B")]);var C='\n              <table id="aat-table-'+a.extId+'" class="display">\n                <thead>\n                  <tr>\n                    <th>qElemNumber</th>\n                    <th>'+a.layout.props.dimensions[0].label+"</th>\n                    <th>"+a.layout.props.measures[0].label+"</th>\n                    <th>Fit</th>\n                    <th>Lower</th>\n                    <th>Upper</th>\n                  </tr>\n                </thead>\n                <tbody>\n                </tbody>\n              </table>";r.draw(s,a,"#aat-table-"+a.extId,w,C,null).then(function(e){r.setEvents(e,a,s)})}}return p.resolve()}),p.promise}}});
//# sourceMappingURL=../../maps/analysis/simple_linear_line.js.map
