define(["../IdevioMap/common/Utils","../IdevioMap/common/ColorManager","../IdevioMap/common/LegendManager","../IdevioMap/common/LocationManager","../IdevioMap/common/MathUtils","../IdevioMap/common/Extension"],function(e,b,f,d,c,h){function a(m,l,j,i){var k=m.color.outline||"#c0c0c0";if(i==="bubbles"){return idevio.map.IconFactory.circle({color:j,radius:l,outline:new b.Color(k).applyAlpha(m.color.alpha).toRgba()})}else{if(i==="bars"){return idevio.map.IconFactory.rectangle({color:j,width:m.barwidth||10,height:l*2,alignX:"middle",alignY:"bottom",outline:new b.Color(k).applyAlpha(m.color.alpha).toRgba()})}else{return idevio.map.IconFactory.polygon({sides:e.POLYGONS[i].sides,color:j,radius:l,rotation:e.POLYGONS[i].rotation,outline:new b.Color(k).applyAlpha(m.color.alpha).toRgba()})}}}function g(k,j,i){h.call(this,"Bubble Layer",k,j,i)}h.extend(g);g.prototype.calcDataSourceIndex=function(){this.locationIdSource_=-1;this.coordinateSource_=-1;var j=-1;var i=this.layout.qHyperCube.qMeasureInfo;var k=e.getValue(this.layout,"location.source","auto");if(k==="auto"){if(i[0]&&!isNaN(i[0].qMax)&&!isNaN(i[0].qMin)){this.coordinateSource_=1;j=3}else{if(i[0]&&isNaN(i[0].qMax)){this.locationIdSource_=1;j=2}else{if(this.layout.qHyperCube.qDimensionInfo[0]){this.locationIdSource_=0;j=1}}}}else{if(k==="coordinates"){this.coordinateSource_=1;j=3}else{if(k==="measure"){this.locationIdSource_=1;j=2}else{if(k==="dimension"){this.locationIdSource_=0;j=1}}}}if(this.coordinateSource_===-1&&this.locationIdSource_!==-1){this.dsType="LocationIds"}if(this.coordinateSource_!==-1&&this.locationIdSource_===-1){this.dsType="Coordinates"}this.isLocationIds=this.dsType==="LocationIds";this.sizeSource_=(i[j-1]&&j!==-1)?j:-1;this.colorSource_=(i[j]&&j!==-1)?j+1:-1};g.prototype.ensureBackCompat=function(l){var j=l||{};e.setIfUndefined(this.layout,"label.slider",j,e.getValueFromLogScaleRevert(e.getValue(this.layout,"label.outres",10000),0,10000,0.1,160000));e.setIfUndefined(this.layout,"restrictDrillDownLevelSlider",j,e.parseListToInterval(this.layout.restrictDrillDownLevel,0,16));if(!this.layout.size){var k,i;if(e.getValue(this.layout,"geometry.shape")==="bars"){k=e.getValue(this.layout,"bars.minHeight",0);i=e.getValue(this.layout,"bars.maxHeight",20)}else{k=e.getValue(this.layout,"Radius.min.value",5);i=e.getValue(this.layout,"Radius.max.value",20)}e.setIfUndefined(this.layout,"size.range",j,[e.getSliderValueFromSize(k),e.getSliderValueFromSize(i)])}e.setIfUndefined(this.layout,"resolutionLimit.range",j,[e.getValueFromLogScaleRevert(this.layout.inResolutionLimit.value,0,10000,0.1,160000),e.getValueFromLogScaleRevert(this.layout.outResolutionLimit.value,0,10000,0.1,160000)]);e.setIfUndefined(this.layout,"barwidth",j,10);e.setIfUndefined(this.layout,"geometry.shape",j,"bubbles");e.setIfUndefined(this.layout,"bars.minHeight",j,0);e.setIfUndefined(this.layout,"bars.maxHeight",j,20);h.prototype.ensureBackCompat.call(this,j)};g.prototype.setStyles=function(k,j){var l=c.validateInt(this.layout.Radius.max.value,20);var i={type:"symbol",iconKey:"sizeAndColor",icons:k,icon:idevio.map.IconFactory.circle({color:"blue",radius:10})};var m={type:"text",textAttribute:"label",font:"8pt sans-serif",placement:"fixed",anchorX:"middle",anchorY:"top",haloColor:"lightgray",pointDistance:j?0:l,pointDistanceKey:"labelOffset"};if(this.layout.label){if(this.layout.label.outres){m.maxRes=this.layout.label.outres}if(this.layout.label.position){m.anchorY=this.layout.label.position}}this.layer.setStyles([i,m])};g.prototype.prePaint=function(o){var n=this.layout;var j=this.layout.qHyperCube.qMeasureInfo;this.maxRadius=e.getValue(n,"Radius.max.value",20);var p=this.map.map;var k;var l=e.isGeoMakePoint(o,this.locationIdSource_);if(this.coordinateSource_!==-1&&this.locationIdSource_===-1){k=false;this.dataset=new idevio.map.MemoryDataset({crs:p.getBaseMap()==="emptymeters"?"emptymeters":null,name:this.id});this.dsType="Coordinates";if(this.layer){this.layer.setDataset(this.dataset)}}else{if(this.coordinateSource_===-1&&this.locationIdSource_!==-1){k=true;if(l){this.dataset=new idevio.map.MemoryDataset({crs:p.getBaseMap()==="emptymeters"?"emptymeters":null,name:this.id});if(this.layer){this.layer.setDataset(this.dataset)}}else{var q=["id","elemNumber","sizeAndColor","label",n.qHyperCube.qDimensionInfo[0].qFallbackTitle,"infoBubbleHtml","labelOffset"];for(var m=0;m<j.length;m++){q.push(j[m].qFallbackTitle)}this.dataset=d.createDataset(this.id,n.location,this.map,q,function(){if(this.layer){this.layer.setDataset(this.dataset);this.setStyles(this.icons,this.isBars)}e.addInfoBubbleTool(this,p,n,"hover_click")}.bind(this))}this.dsType="LocationIds"}}this.isLocationIds=this.dsType==="LocationIds";if(this.isLocationIds){this.remap=d.prepareRemap(n.location)}};g.prototype.paint=function(Q){var B=this.layout.qHyperCube.qMeasureInfo;if(!this.isLocationIds&&B.length<2){return}var J;if(this.isLocationIds){J=e.isGeoMakePoint(Q,this.locationIdSource_)}this.isBars=this.layout.geometry.shape==="bars";var v=c.validateInt(this.layout.Radius.min.value,5);var o=c.validateInt(this.layout.Radius.max.value,20);var q=c.validateInt(this.layout.bars.minHeight,1);var A=c.validateInt(this.layout.bars.maxHeight,20);var L=[];var P={};var G=[];for(var N=0;N<Q.length;N++){G=Q[N].qMatrix;for(var I=0;I<G.length;I++){var z=G[I];var O=z[0];if(O.qIsEmpty||(O.qElemNumber<0)||O.qIsNull||!O.qText){continue}var r=this.isLocationIds?1:2;if(this.isLocationIds&&!this.isLocationDataValid(z,r)){continue}var w;var D;if(this.isLocationIds&&!J){w=d.getLocationIds(this.layout,z,this.locationIdSource_,this.remap,1)[0]}else{if(this.isLocationIds&&J){D=d.getQlikPoints(z,this.locationIdSource_,1)[0]}else{D=d.getCoordinates(z,this.coordinateSource_,1)[0]}}var y=10;if(this.isLocationIds&&(z.length===1||z.length===2)){if(this.isBars){y=c.validateInt((this.layout.bars.minHeight+this.layout.bars.maxHeight)/2,10)}else{y=c.validateInt((this.layout.Radius.max.value+this.layout.Radius.min.value)/2,10)}}if(this.sizeSource_!==-1&&B[this.sizeSource_-1].qMin!==B[this.sizeSource_-1].qMax){var l;var j;if(!this.layout.Radius.maxValue.manual){l=c.validateFloat(this.layout.Radius.maxValue.value,B[this.sizeSource_-1].qMax)}else{l=B[this.sizeSource_-1].qMax}if(!this.layout.Radius.minValue.manual){j=c.validateFloat(this.layout.Radius.minValue.value,B[this.sizeSource_-1].qMin)}else{j=B[this.sizeSource_-1].qMin}var x=this.getSizeValue(z,B);if(this.isBars){y=this.calcRadius(x,q,A,j,l)}else{y=this.calcRadius(x,v,o,j,l)}}else{if(this.isBars){y=c.validateInt((this.layout.bars.maxHeight+this.layout.bars.minHeight)/2,10)}else{y=c.validateInt((this.layout.Radius.max.value+this.layout.Radius.min.value)/2,10)}}var p=this.getColorObject(z,O);var E=p.color;if(this.isByDimension&&this.layout.qHyperCube.qDimensionInfo[0].qAttrDimInfo.length>0){this.colorInfo_[String(O.qAttrDims.qValues[0].qText)]=p.color}else{if(this.isByDimension){this.colorInfo_[String(O.qText)]=p.color}else{this.colorInfo_[String(p.index)]=true}}var F=this.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle;var u=e.getLabelText(z,this.layout);var M=e.getValue(z[1],"qAttrExps.qValues.3.qText","");var n=e.getValue(z[1],"qAttrExps.qValues.4.qNum",1);var t=e.getValue(z[1],"qAttrExps.qValues.5.qNum",0);var H=(this.isBars)?2:y+2-o;if(isNaN(n)){n=1}if(isNaN(t)){t=0}var C=(this.layout.geometry.shape==="symbols")?M+"|"+n+"|"+t:y+"|"+E;var m=e.getInfoBubbleHtml(z,B,this.layout,this);if(!P[C]){if(this.layout.geometry.shape==="symbols"&&M!==""){P[C]=new idevio.map.Icon({url:M,scale:n,rotation:t,viaServer:true})}else{if(this.layout.geometry.shape!=="symbols"&&y>=0){P[C]=a(this.layout,y,E,this.layout.geometry.shape)}}}if(this.isLocationIds&&!J){var k=[w,O.qElemNumber,C,u,O.qText,m,H];L.push(k)}else{var s={dimension:this.dimension,elemNumber:O.qElemNumber,id:O.qText,infoBubbleHtml:m,label:u,sizeAndColor:C,labelOffset:H};s[F]=O.qText;try{new idevio.map.PointFeature(this.dataset,{coordinate:D,attributes:s})}catch(K){this.addWarning("bubblePointFeature","Error adding feature",undefined,"["+D[0]+","+D[1]+"]")}}}}if(G.length===0){return}if(this.isLocationIds&&!J){this.icons=P;this.dataset.setData(L)}else{this.setStyles(P,this.isBars)}if(this.dsType!=="LocationIds"||J){setTimeout(function(){var i=(this.layout.includeInAutoZoom!==false&&this.dataset.getAll().length>0)?this.dataset.getAlternateBounds():null;this.map.doneWorkViewBounds(this.id,i);e.addInfoBubbleTool(this,this.map.map,this.layout,"hover_click")}.bind(this),0)}};g.prototype.calcRadius=function(n,m,k,l,o){var j=o-l;var i;j=isNaN(j)?0:j;n=isNaN(n)?0:n;if(n<=l){i=m}else{if(n>=o){i=k}else{i=(j<=0)?Math.floor((m+k)/2):Math.floor((n-l)/j*(k-m)+m)}}return i};g.prototype.paintLegend=function(){var t=this.layout.qHyperCube.qMeasureInfo;var y=e.getValue(this.layout,"legend.sizes.auto",true);var u=e.getValue(this.layout,"legend.sizes.showSizes",true);var o=e.getValue(this.layout,"legend.sizes.showMinMax",true);var p=e.getValue(this.layout,"legend.sizes.showTitle",true);var s=e.getValue(this.layout,"geometry.shape","");var i=y||u;var j=$("#legend-info-"+this.id).empty();var n=$("<div>").addClass("legend-data-info").appendTo(j);var w={};if(s!=="symbols"){if(this.sizeSource_!==-1){var k=isNaN(t[this.sizeSource_-1].qMin)?0:t[this.sizeSource_-1].qMin;var x=isNaN(t[this.sizeSource_-1].qMax)?0:t[this.sizeSource_-1].qMax;w={max:(!this.layout.Radius.maxValue.manual)?this.layout.Radius.maxValue.value:x,min:(!this.layout.Radius.minValue.manual)?this.layout.Radius.minValue.value:k,title:t[this.sizeSource_-1].qFallbackTitle};if(this.layout.geometry.shape==="bars"){w.maxradius=this.layout.bars.maxHeight;w.minradius=this.layout.bars.minHeight}else{w.maxradius=this.layout.Radius.max.value;w.minradius=this.layout.Radius.min.value}}if(y||o){if(w.max>w.min&&w.maxradius>w.minradius){var m=c.formatNumberForDisplay(w.max);var r=c.formatNumberForDisplay(w.min);var l=!e.getValue(this.layout,"Radius.minValue.manual",true);var q=!e.getValue(this.layout,"Radius.maxValue.manual",true);if(l){r="<"+c.formatNumberForDisplay(this.layout.Radius.minValue.value)}if(q){m=">"+c.formatNumberForDisplay(this.layout.Radius.maxValue.value)}$("<span>").addClass("data-info-min").html(r).appendTo(n);$("<span>").addClass("data-info-max").html(m).appendTo(n)}}if(this.isVisible()){f.createColorLegend(j,this.layout,t,this.colorSource_,this.colorInfo_)}}if(i){$("<div>").addClass("legend-size").append(f.createBubblesForLegend(w,j.height(),this.layout,this.isSingleColor)).appendTo(j)}else{n.css("left","-30px")}if(y||p){var v;if(this.sizeSource_!==-1&&t[this.sizeSource_-1]){v=t[this.sizeSource_-1].qFallbackTitle}else{v=e.getValue(this.layout,"qHyperCube.qDimensionInfo.0.qFallbackTitle")}$("<span>").addClass("data-info-title").html(v).appendTo(n)}f.dimLegend(this.id,!this.isVisible());f.fixHeightForLegend(this.id);f.fixWidthForLegend(this.id);$("<div>").addClass("legend-control").appendTo(j)};return g});