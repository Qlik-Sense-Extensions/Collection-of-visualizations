define(["../IdevioMap/common/Utils","../IdevioMap/common/LegendManager","../IdevioMap/common/LocationManager","../IdevioMap/common/MathUtils","../IdevioMap/common/Extension"],function(f,g,c,b,h){var a=["rgba(0,0,0,0)","rgba(5,5,85,0.5)","rgba(0,234,242,0.65)","rgba(0,180,65,0.65)","rgba(220,252,5,0.65)","rgba(255,1,1,0.65)","rgba(255,237,237,0.65)"];var e=[0,0.15,0.3,0.45,0.6,0.8,1];function d(k,j,i){h.call(this,"Heatmap Layer",k,j,i)}h.extend(d);d.prototype.ensureBackCompat=function(j){var i=j||{};f.setIfUndefined(this.layout,"restrictDrillDownLevelSlider",i,f.parseListToInterval(this.layout.restrictDrillDownLevel,0,16));f.setIfUndefined(this.layout,"color.alpha",i,1);h.prototype.ensureBackCompat.call(this,i)};d.prototype.calcDataSourceIndex=function(){this.locationIdSource_=-1;this.coordinateSource_=-1;var j=-1;var i=this.layout.qHyperCube.qMeasureInfo;var k=f.getValue(this.layout,"location.source","auto");if(k==="auto"){if(i[0]&&!isNaN(i[0].qMax)&&!isNaN(i[0].qMin)){this.coordinateSource_=1;j=3}else{if(i[0]&&isNaN(i[0].qMax)){this.locationIdSource_=1;j=2}else{if(this.layout.qHyperCube.qDimensionInfo[0]){this.locationIdSource_=0;j=1}}}}else{if(k==="coordinates"){this.coordinateSource_=1;j=3}else{if(k==="measure"){this.locationIdSource_=1;j=2}else{if(k==="dimension"){this.locationIdSource_=0;j=1}}}}this.weightSource_=(i[j-1]&&j!==-1)?j:-1};d.prototype.init=function(i){h.prototype.init.call(this,i);this.controlSelect=false;this.listener=this.map.map.addListener("idle",function(){var j=this.layer?this.layer.getMaxIntensity():1;this.element.find(".color-info-max").html(b.formatNumberForDisplay(j))}.bind(this))};d.prototype.layerInit=function(){this.clearLayer(true);var i=this.getColorsAndDistFromProperties();this.layer=new idevio.map.HeatmapLayer(this.map.map,{name:this.layerTitle,visible:this.visible,dataset:this.dataset,pickable:false,minRes:this.layout.inResolutionLimit.value,maxRes:this.layout.outResolutionLimit.value,drawOrder:f.getDrawOrder(this.layout),styles:[],meta:{qvlayer:this},autoScale:this.layout.autoScale,radiusUnit:this.layout.radiusUnit,radius:this.layout.radius,alpha:this.layout.color.alpha,colors:i.colors,colorDistribution:i.distribution,normalizeWeights:false,commonWeight:this.layout.autoScale?1:this.layout.commonWeight,weightAttribute:this.weightSource_===-1?undefined:"weight"})};d.prototype.getColorsAndDistFromProperties=function(m){var l=m||this.layout;var j=l.color;var n=j.distribution;var i=j.auto||!j.colors||!j.colors.length;if(i){return{colors:a,distribution:e}}var k=!n||n.length!==j.colors.length||n[0]!==0||n[n.length-1]!==1;return{colors:j.colors,distribution:k?undefined:n}};d.prototype.prePaint=function(j){var k=this.map.map;if(this.coordinateSource_!==-1&&this.locationIdSource_===-1){this.dataset=new idevio.map.MemoryDataset({crs:k.getBaseMap()==="emptymeters"?"emptymeters":null,name:this.id});this.layer.setDataset(this.dataset);this.dsType="Coordinates"}else{if(this.coordinateSource_===-1&&this.locationIdSource_!==-1){var i=f.isGeoMakePoint(j,this.locationIdSource_);if(i){this.dataset=new idevio.map.MemoryDataset({crs:k.getBaseMap()==="emptymeters"?"emptymeters":null,name:this.id});this.layer.setDataset(this.dataset)}else{this.dataset=c.createDataset(this.id,this.layout.location,this.map,["id","weight"],function(){if(this.layer){this.layer.setDataset(this.dataset)}}.bind(this))}this.dsType="LocationIds"}}this.isLocationIds=this.dsType==="LocationIds";this.layer.setWeightAttribute(this.weightSource_===-1?undefined:"weight")};d.prototype.paint=function(m){var p=this.layout.qHyperCube.qMeasureInfo;if(!this.isLocationIds&&p.length<2){return}var r;if(this.isLocationIds){r=f.isGeoMakePoint(m,this.locationIdSource_)}var w=[];var s=[];for(var q=0;q<m.length;q++){s=m[q].qMatrix;for(var x=0;x<s.length;x++){var j=s[x];var l=j[0];var n;var v;var u;if(l.qIsEmpty||(l.qElemNumber<0)||l.qIsNull||!l.qText){continue}var k=this.isLocationIds?1:2;if(!this.isLocationDataValid(j,k)){continue}if(this.weightSource_!==-1){var t=j[this.weightSource_];n=isNaN(t.qNum)?t.qText:t.qNum;if(isNaN(n)){this.addWarning("heatmapInvalidWeight","Invalid weight value",l,n);continue}}if(this.isLocationIds&&!r){v=c.getLocationIds(this.layout,j,this.locationIdSource_,this.remap,1)[0];w.push([v,n])}else{if(r){u=c.getQlikPoints(j,this.locationIdSource_,1)[0]}else{u=c.getCoordinates(j,this.coordinateSource_,1)[0]}try{new idevio.map.PointFeature(this.dataset,{coordinate:u,attributes:{weight:n}})}catch(o){this.addWarning("heatmapErrorFeature","Error adding feature",l,u)}}}}if(this.isLocationIds&&s.length>0&&!r){this.dataset.setData(w)}if(!this.isLocationIds){var i=(this.layout.includeInAutoZoom!==false&&this.dataset.getAll().length>0)?this.dataset.getAlternateBounds():null;this.map.doneWorkViewBounds(this.id,i)}};d.prototype.paintLegend=function(){var w=this.layout.qHyperCube.qMeasureInfo;var m=f.getValue(this.layout,"legend.colors.auto",true);var k=f.getValue(this.layout,"legend.colors.showColors",true);var n=f.getValue(this.layout,"legend.colors.showMinMax",true);var s=f.getValue(this.layout,"legend.colors.showTitle",true);var p=f.getValue(this.layout,"legend.showIconTitle",true);var o=f.getValue(this.layout,"legend.showIcon",true);var l=$("#legend-info-"+this.id).empty();var x=$("<div>").addClass("legend-data-info").appendTo(l);var i=$("<div>").addClass("legend-color").appendTo(l);var y=$("<div>").addClass("color-info").appendTo(i);var j=this.isVisible();var u="";var z="";if(p){u=f.getValue(this.layout,"qHyperCube.qDimensionInfo.0.qFallbackTitle");$("<span>").addClass("data-info-title").html(u).appendTo(x)}$("<p>").addClass("legend-title").appendTo(l);if(j&&(m||k)){var q=this.layer?this.layer.getColors():a;var v=this.layer?this.layer.getColorDistribution():e;i.append(g.createColorBar(q,true,v))}if(j&&(m||s)){if(this.weightSource_!==-1&&Boolean(w[this.weightSource_-1])){z=w[this.weightSource_-1].qFallbackTitle}$("<span>").addClass("color-title").html(z).appendTo(y)}if(j&&(m||n)){var t=b.formatNumberForDisplay(1);var r=b.formatNumberForDisplay(0);$("<span>").addClass("color-info-max").html(t).appendTo(y);$("<span>").addClass("color-info-min").html(r).appendTo(y)}g.dimLegend(this.id,!this.isVisible());g.fixSizeForIcon(this.id);g.fixHeightForLegend(this.id);g.fixWidthForLegend(this.id);if(!o){l.css("background-size","0");x.css("left","-30px")}};d.prototype.destroy=function(){if(this.map){this.map.map.removeListener(this.listener)}h.prototype.destroy.call(this)};return d});