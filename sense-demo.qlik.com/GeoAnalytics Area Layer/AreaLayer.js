define(["../IdevioMap/common/Utils","../IdevioMap/common/ColorManager","../IdevioMap/common/LegendManager","../IdevioMap/common/LocationManager","../IdevioMap/common/Extension"],function(d,a,e,c,f){function b(i,h,g){f.call(this,"Area Layer",i,h,g)}f.extend(b);b.prototype.calcDataSourceIndex=function(){this.locationIdSource_=-1;var h=-1;var g=this.layout.qHyperCube.qMeasureInfo;var i=d.getValue(this.layout,"location.source","auto");if(i==="auto"){if(g[0]&&isNaN(g[0].qMax)){this.locationIdSource_=1;h=2}else{if(this.layout.qHyperCube.qDimensionInfo[0]){this.locationIdSource_=0;h=1}}}else{if(i==="measure"){this.locationIdSource_=1;h=2}else{if(i==="dimension"){this.locationIdSource_=0;h=1}}}this.dsType="LocationIds";this.colorSource_=h};b.prototype.ensureBackCompat=function(h){var g=h||{};d.setIfUndefined(this.layout,"label.slider",g,d.getValueFromLogScaleRevert(d.getValue(this.layout,"label.outres",10000),0,10000,0.1,160000));d.setIfUndefined(this.layout,"restrictDrillDownLevelSlider",g,d.parseListToInterval(this.layout.restrictDrillDownLevel,0,16));f.prototype.ensureBackCompat.call(this,g)};b.prototype.setStyles=function(k,g){var i=k.color.outline||"#aaaaaa";var j={type:"polygon",color:this.isSingleColor?a.getPrimaryColor(k):"rgba(100,100,100,0.2)",colorKey:this.isSingleColor?null:"color",colors:this.isSingleColor?null:g,outline:new a.Color(i).applyAlpha(k.color.alpha).toRgba()};var h={type:"text",textAttribute:"label",font:"8pt sans-serif",placement:"FIXED",anchorX:"MIDDLE",anchorY:"MIDDLE",haloColor:"lightgray"};if(k.label&&k.label.outres){h.maxRes=k.label.outres}this.layer.setStyles([j,h])};b.prototype.prePaint=function(g){var h=this.map.map;var i=["id","color","elemNumber","label","infoBubbleHtml"];this.isGeometry=d.isQlikGeometry(g,this.locationIdSource_);if(this.isGeometry){this.dataset=new idevio.map.MemoryDataset({crs:h.getBaseMap()==="emptymeters"?"emptymeters":null,name:this.id});if(this.layer){this.layer.setDataset(this.dataset)}}else{this.dataset=c.createDataset(this.id,this.layout.location,this.map,i,function(){if(this.layer){this.layer.setDataset(this.dataset);this.setStyles(this.layout,this.colorTable)}this.dataLoaded=true;d.addInfoBubbleTool(this,h,this.layout,"hover_click")}.bind(this))}};b.prototype.paint=function(z){var r=this.layout.qHyperCube.qMeasureInfo;var v=[];var h;this.colorTable=(this.isColorExpression||this.isSchemeGradient)?{}:a.getColorScheme(this.layout);for(var w=0;w<z.length;w++){var s=z[w].qMatrix;for(var k=0;k<s.length;k++){var q=s[k];var x=q[0];if(x.qIsEmpty||(x.qElemNumber<0)||x.qIsNull||!x.qText){continue}var l=1;if(!this.isGeometry&&!this.isLocationDataValid(q,l)){continue}var o;var p;if(this.isGeometry){p=q[this.locationIdSource_].qText}else{o=c.getLocationIds(this.layout,q,this.locationIdSource_,this.remap,1)[0]}if(!this.isSingleColor){var i=this.getColorObject(q,x);h=i.index;if(this.isByDimension&&this.layout.qHyperCube.qDimensionInfo[0].qAttrDimInfo.length>0){this.colorInfo_[String(x.qAttrDims.qValues[0].qText)]=i.color}else{this.colorInfo_[String(i.index)]=true}if(this.isColorExpression||this.isSchemeGradient){this.colorTable[h]=i.color}}var t=this.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle;var m=d.getLabelText(q,this.layout);var g=d.getInfoBubbleHtml(q,r,this.layout,this);if(this.isGeometry){var n={color:h,dimension:this.dimension,elemNumber:x.qElemNumber,id:x.qText,infoBubbleHtml:g,label:m};n[t]=x.qText;var y=[];try{y=y.concat.apply(y,JSON.parse(p)).map(d.switchCoordinates);new idevio.map.PolygonFeature(this.dataset,{coordinates:y,attributes:n})}catch(u){this.addWarning("areaPolygonFeature","Error adding polygon feature",undefined,"["+y+"]")}}else{v.push([o,h,x.qElemNumber,m,g])}}}if(this.isGeometry){this.setStyles(this.layout,this.colorTable)}else{this.dataset.setData(v)}if(this.isGeometry){var j=(this.layout.includeInAutoZoom!==false&&this.dataset.getAll().length>0)?this.dataset.getAlternateBounds():null;this.map.doneWorkViewBounds(this.id,j);d.addInfoBubbleTool(this,this.map.map,this.layout,"hover_click")}};b.prototype.paintLegend=function(){var g=this.layout.qHyperCube.qMeasureInfo;var l=d.getValue(this.layout,"legend.showIconTitle",true);var k=d.getValue(this.layout,"legend.showIcon",true);var h=$("#legend-info-"+this.id).empty();var i=$("<div>").addClass("legend-data-info").appendTo(h);if(l){var j=d.getValue(this.layout,"qHyperCube.qDimensionInfo.0.qFallbackTitle");$("<span>").addClass("data-info-title").html(j).appendTo(i)}if(this.isVisible()){e.createColorLegend(h,this.layout,g,this.colorSource_,this.colorInfo_)}e.dimLegend(this.id,!this.isVisible());e.fixSizeForIcon(this.id);e.fixHeightForLegend(this.id);e.fixWidthForLegend(this.id);if(!k){h.css("background-size","0");i.css("left","-30px")}};return b});