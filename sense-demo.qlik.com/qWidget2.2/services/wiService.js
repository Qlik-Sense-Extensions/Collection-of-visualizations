define(["underscore","angular","qvangular","../modules/utils/wiUtils","./../lib/external/less/less-1.7.3.min"],function(a,b,c,d,e){"use strict";c.service("wiService",["$q","$timeout","$compile",function(a,c,f){return{getLocalExtensionVersion:function(a){return a.$parent.ext.libraryInfo.version},compileString:function(b,e){var g=a.defer();if(!d.isBlank(e)&&d.hasAngularBindings(e)){var h="",i=f("<div>"+e+"</div>")(b),j=c(function(){h=i[0].innerText},0);j.then(function(){g.resolve(h)}),b.$on("$destroy",function(){j&&c.cancel(j)})}else g.resolve(e);return g.promise},applyChanges:function(a){a.backendApi.getProperties().then(function(c){c.widgetHtml=a.layout.widgetHtml,c.widgetLess=a.layout.widgetLess,a.backendApi.save().then(function(){b.noop()}).catch(function(){b.noop()})}).catch(function(){})},applyEditor:function(a){var c=this,e=a.WidgetEditor.less,f=a.WidgetEditor.html;this.compileString(a,e).then(function(){a.layout.widgetHtml=d.encodeForEngine(f),a.layout.widgetLess=d.encodeForEngine(e),c.applyChanges(a)}).catch(function(a){b.noop()})},createScopedCss:function(a,b){var c=this.createLessWrapper(a,b),d="";return(new e.Parser).parse(c,function(a,b){return void 0===b?"":void(d=b.toCSS())}),d},createLessWrapper:function(a,b){var c="";return c="#"+a+" {"+b+"}"},watchersContainedIn:function(a){for(var b=a.$$watchers?a.$$watchers.length:0,c=a.$$childHead;c;)b+=c.$$watchers?c.$$watchers.length:0,c=c.$$nextSibling;return b}}}])});