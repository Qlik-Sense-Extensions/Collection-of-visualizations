define(["jquery","underscore","angular","qvangular","./wiRepositoryService"],function(a,b,c,d){"use strict";d.service("wiMainRepositoryService",["$q","wiRepositoryService",function(a,b){var d,e,f,g,h=!1,i=function(){var b=a.defer(),c=this;return c.initialized?b.resolve(!0):j.call(c).then(function(){var d=k.call(c),e=l.call(c);a.all([d,e]).then(function(){c.initialized=!0,b.resolve(!0)}).catch(function(){c.initialized=!1,b.reject(!1)})}).catch(function(){c.initialized=!1,b.reject(!1)}),b.promise},j=function(){var c=this,d=a.defer();return b.getMainRepository().then(function(a){c.rep=a,b.ping(a).then(function(a){c.isOnline=!0,d.resolve({pingResult:!0,data:a.data})}).catch(function(a){c.isOnline=!1,d.reject({pingResult:!1,error:a.error,errorStatus:a.status})})}).catch(function(){c.isOnline=!1,d.reject({pingResult:!1,error:"Cannot retrieve the main repository."})}),d.promise},k=function(){var c=this,d=a.defer();return b.getUpdates(c.currentVersion,c.rep).then(function(a){c.updateInfo=a,d.resolve(a)}).catch(function(a){d.reject(a)}),d.promise},l=function(){var c=this,d=a.defer();return b.getSnippets(c.rep).then(function(a){c.snippets=a,d.resolve(a)}).catch(function(a){d.reject(a)}),d.promise},m=function(d){var e=a.defer();return b.trackSnippetUse(this.rep,d._id).then(function(){c.noop(),e.resolve(!0)}).catch(function(a){e.reject(a)}),e.promise};return{currentVersion:f,init:i,initUpdateInfo:k,initSnippets:l,isOnline:e,initialized:h,rep:d,updateInfo:g,trackSnippetUse:m}}])});