define(["angular","qvangular","objects.extension/base-controller","../wiUiDateParser/wiUiDateParser","../wiUiPosition/wiUiPosition","../assets/wiVariableService","../../modules/utils/wiUtils"],function(a,b,c,d,e,f,g){"use strict";var h={formatDay:"dd",formatMonth:"MMMM",formatYear:"yyyy",formatDayHeader:"EEE",formatDayTitle:"MMMM yyyy",formatMonthTitle:"yyyy",datepickerMode:"day",minMode:"day",maxMode:"year",showWeeks:!0,startingDay:0,yearRange:20,minDate:null,maxDate:null,btnSize:"xs"},i=function(b,c,d){b.dt=c.startDate||new Date;var e=new Date;b.minDate=c.minDate||e.setFullYear(parseInt(parseInt(e.getFullYear())-1)),b.maxDate=c.maxDate||e.setFullYear(parseInt(parseInt(e.getFullYear())+2)),b.showWeeks=c.showWeeks||h.showWeeks,b.yearRange=c.yearRange||h.yearRange,b.btnSize=c.btnSize||h.btnSize,b.var=c.bindQsVar,b.popup=c.popup||!1,b.popOpened=!1,b.open=function(a){a.preventDefault(),a.stopPropagation(),b.popOpened=!0},b.close=function(){b.popOpened=!1},b.clear=function(){b.dt=null},b.$watch("dt",function(c){if(c&&a.isDate(c)){var e="=makedate("+c.getFullYear()+","+parseInt(parseInt(c.getMonth())+1)+","+c.getDate()+")";d.setVariableContent(b.var,e)}})};i.$inject=["$scope","$attrs","wiVariableService"];var j=function(b,c,d,e,f,g,i){var j=this,k={$setViewValue:a.noop};this.modes=["day","month","year"],a.forEach(["formatDay","formatMonth","formatYear","formatDayHeader","formatDayTitle","formatMonthTitle","minMode","maxMode","showWeeks","startingDay","yearRange"],function(d,f){j[d]=a.isDefined(c[d])?8>f?e(c[d])(b.$parent):b.$parent.$eval(c[d]):h[d]}),a.forEach(["minDate","maxDate"],function(a){c[a]?b.$parent.$watch(d(c[a]),function(b){j[a]=b?new Date(b):null,j.refreshView()}):j[a]=h[a]?new Date(h[a]):null}),b.datepickerMode=b.datepickerMode||h.datepickerMode,b.uniqueId="datepicker-"+b.$id+"-"+Math.floor(1e4*Math.random()),this.activeDate=a.isDefined(c.initDate)?b.$parent.$eval(c.initDate):new Date,b.isActive=function(a){return 0===j.compare(a.date,j.activeDate)?(b.activeDateId=a.uid,!0):!1},this.init=function(a){k=a,k.$render=function(){j.render()}},this.render=function(){if(k.$modelValue){var a=new Date(k.$modelValue),b=!isNaN(a);b?this.activeDate=a:g.error('Datepicker directive: "ng-model" value must be a Date object, a number of milliseconds since 01.01.1970 or a string representing an RFC2822 or ISO 8601 date.'),k.$setValidity("date",b)}this.refreshView()},this.refreshView=function(){if(this.element){this._refreshView();var a=k.$modelValue?new Date(k.$modelValue):null;k.$setValidity("date-disabled",!a||this.element&&!this.isDisabled(a))}},this.createDateObject=function(a,b){var c=k.$modelValue?new Date(k.$modelValue):null;return{date:a,label:i(a,b),selected:c&&0===this.compare(a,c),disabled:this.isDisabled(a),current:0===this.compare(a,new Date)}},this.isDisabled=function(a){return this.minDate&&this.compare(a,this.minDate)<0||this.maxDate&&this.compare(a,this.maxDate)>0||c.dateDisabled&&b.dateDisabled({date:a,mode:b.datepickerMode})},this.split=function(a,b){for(var c=[];a.length>0;)c.push(a.splice(0,b));return c},b.select=function(a){if(b.datepickerMode===j.minMode){var c=k.$modelValue?new Date(k.$modelValue):new Date(0,0,0,0,0,0,0);c.setFullYear(a.getFullYear(),a.getMonth(),a.getDate()),k.$setViewValue(c),k.$render()}else j.activeDate=a,b.datepickerMode=j.modes[j.modes.indexOf(b.datepickerMode)-1]},b.move=function(a){var b=j.activeDate.getFullYear()+a*(j.step.years||0),c=j.activeDate.getMonth()+a*(j.step.months||0);j.activeDate.setFullYear(b,c,1),j.refreshView()},b.toggleMode=function(a){a=a||1,b.datepickerMode===j.maxMode&&1===a||b.datepickerMode===j.minMode&&-1===a||(b.datepickerMode=j.modes[j.modes.indexOf(b.datepickerMode)+a])},b.keys={13:"enter",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down"};var l=function(){f(function(){j.element[0].focus()},0,!1)};b.$on("datepicker.focus",l),b.keydown=function(a){var c=b.keys[a.which];if(c&&!a.shiftKey&&!a.altKey)if(a.preventDefault(),a.stopPropagation(),"enter"===c||"space"===c){if(j.isDisabled(j.activeDate))return;b.select(j.activeDate),l()}else!a.ctrlKey||"up"!==c&&"down"!==c?(j.handleKeyDown(c,a),j.refreshView()):(b.toggleMode("up"===c?1:-1),l())}};j.$inject=["$scope","$attrs","$parse","$interpolate","$timeout","$log","dateFilter"],b.directive("wiDatepicker",["$compile",function(){return{restrict:"E",replace:!0,templateUrl:"/extensions/qWidget/components/wiDatepicker/template/wiDatepicker.ng.html",scope:{popup:"@",minDate:"@",maxDate:"@",showWeeks:"@"},controller:i,require:["wiDatepicker"],compile:function(){return g.addStyleLinkToHeader("wiBootstrap","/extensions/qWidget/components/wiBootstrap/css/wiBootstrap.css"),{pre:function(){},post:function(){}}}}}]),b.directive("datepicker",["$compile",function(){return{restrict:"EA",replace:!0,templateUrl:"/extensions/qWidget/components/wiDatePicker/template/datepicker.ng.html",scope:{datepickerMode:"=?",dateDisabled:"&"},require:["datepicker","?^ngModel"],controller:j,compile:function(){return{pre:function(){},post:function(a,b,c,d){var e=d[0],f=d[1];f&&f&&e.init(f)}}}}}]),b.directive("daypicker",["dateFilter",function(b){return{restrict:"EA",replace:!0,templateUrl:"/extensions/qWidget/components/wiDatePicker/template/day.ng.html",require:"^datepicker",link:function(c,d,e,f){function g(a,b){return 1!==b||a%4!==0||a%100===0&&a%400!==0?j[b]:29}function h(a,b){var c=new Array(b),d=new Date(a),e=0;for(d.setHours(12);b>e;)c[e++]=new Date(d),d.setDate(d.getDate()+1);return c}function i(a){var b=new Date(a);b.setDate(b.getDate()+4-(b.getDay()||7));var c=b.getTime();return b.setMonth(0),b.setDate(1),Math.floor(Math.round((c-b)/864e5)/7)+1}c.showWeeks=f.showWeeks,f.step={months:1},f.element=d;var j=[31,28,31,30,31,30,31,31,30,31,30,31];f._refreshView=function(){var d=f.activeDate.getFullYear(),e=f.activeDate.getMonth(),g=new Date(d,e,1),j=f.startingDay-g.getDay(),k=j>0?7-j:-j,l=new Date(g);k>0&&l.setDate(-k+1);for(var m=h(l,42),n=0;42>n;n++)m[n]=a.extend(f.createDateObject(m[n],f.formatDay),{secondary:m[n].getMonth()!==e,uid:c.uniqueId+"-"+n});c.labels=new Array(7);for(var o=0;7>o;o++)c.labels[o]={abbr:b(m[o].date,f.formatDayHeader),full:b(m[o].date,"EEEE")};if(c.title=b(f.activeDate,f.formatDayTitle),c.rows=f.split(m,7),c.showWeeks){c.weekNumbers=[];for(var p=i(c.rows[0][0].date),q=c.rows.length;c.weekNumbers.push(p++)<q;)a.noop()}},f.compare=function(a,b){return new Date(a.getFullYear(),a.getMonth(),a.getDate())-new Date(b.getFullYear(),b.getMonth(),b.getDate())},f.handleKeyDown=function(a){var b=f.activeDate.getDate();if("left"===a)b-=1;else if("up"===a)b-=7;else if("right"===a)b+=1;else if("down"===a)b+=7;else if("pageup"===a||"pagedown"===a){var c=f.activeDate.getMonth()+("pageup"===a?-1:1);f.activeDate.setMonth(c,1),b=Math.min(g(f.activeDate.getFullYear(),f.activeDate.getMonth()),b)}else"home"===a?b=1:"end"===a&&(b=g(f.activeDate.getFullYear(),f.activeDate.getMonth()));f.activeDate.setDate(b)},f.refreshView()}}}]),b.directive("monthpicker",["dateFilter",function(b){return{restrict:"EA",replace:!0,templateUrl:"/extensions/qWidget/components/wiDatePicker/template/month.ng.html",require:"^datepicker",link:function(c,d,e,f){f.step={years:1},f.element=d,f._refreshView=function(){for(var d=new Array(12),e=f.activeDate.getFullYear(),g=0;12>g;g++)d[g]=a.extend(f.createDateObject(new Date(e,g,1),f.formatMonth),{uid:c.uniqueId+"-"+g});c.title=b(f.activeDate,f.formatMonthTitle),c.rows=f.split(d,3)},f.compare=function(a,b){return new Date(a.getFullYear(),a.getMonth())-new Date(b.getFullYear(),b.getMonth())},f.handleKeyDown=function(a){var b=f.activeDate.getMonth();if("left"===a)b-=1;else if("up"===a)b-=3;else if("right"===a)b+=1;else if("down"===a)b+=3;else if("pageup"===a||"pagedown"===a){var c=f.activeDate.getFullYear()+("pageup"===a?-1:1);f.activeDate.setFullYear(c)}else"home"===a?b=0:"end"===a&&(b=11);f.activeDate.setMonth(b)},f.refreshView()}}}]),b.directive("yearpicker",["dateFilter",function(){return{restrict:"EA",replace:!0,templateUrl:"/extensions/qWidget/components/wiDatePicker/template/year.ng.html",require:"^datepicker",link:function(b,c,d,e){function f(a){return parseInt((a-1)/g,10)*g+1}var g=e.yearRange;e.step={years:g},e.element=c,e._refreshView=function(){for(var c=new Array(g),d=0,h=f(e.activeDate.getFullYear());g>d;d++)c[d]=a.extend(e.createDateObject(new Date(h+d,0,1),e.formatYear),{uid:b.uniqueId+"-"+d});b.title=[c[0].label,c[g-1].label].join(" - "),b.rows=e.split(c,5)},e.compare=function(a,b){return a.getFullYear()-b.getFullYear()},e.handleKeyDown=function(a){var b=e.activeDate.getFullYear();"left"===a?b-=1:"up"===a?b-=5:"right"===a?b+=1:"down"===a?b+=5:"pageup"===a||"pagedown"===a?b+=("pageup"===a?-1:1)*e.step.years:"home"===a?b=f(e.activeDate.getFullYear()):"end"===a&&(b=f(e.activeDate.getFullYear())+g-1),e.activeDate.setFullYear(b)},e.refreshView()}}}]);var k={datepickerPopup:"yyyy-MM-dd",currentText:"Today",clearText:"Clear",closeText:"Close",closeOnDateSelection:!0,appendToBody:!0,showButtonBar:!1},l=c.extend({init:function(){}});l.$inject=["$scope","$attrs"],b.directive("datepickerPopup",["$compile","$parse","$document","uiPositionService","dateFilter","wiUiDateParser",function(b,c,d,e,f,g){return{restrict:"EA",require:["datepickerPopup","ngModel"],controller:l,scope:{isOpen:"=?",currentText:"@",clearText:"@",closeText:"@",dateDisabled:"&"},link:function(h,i,j,l){function m(a){return a.replace(/([A-Z])/g,function(a){return"-"+a.toLowerCase()})}function n(b){if(b){if(a.isDate(b)&&!isNaN(b))return p.$setValidity("date",!0),b;if(a.isString(b)){var c=g.parse(b,o)||new Date(b);return isNaN(c)?void p.$setValidity("date",!1):(p.$setValidity("date",!0),c)}return void p.$setValidity("date",!1)}return p.$setValidity("date",!0),null}var o,p=(l[0],l[1]),q=a.isDefined(j.closeOnDateSelection)?h.$parent.$eval(j.closeOnDateSelection):k.closeOnDateSelection,r=a.isDefined(j.datepickerAppendToBody)?h.$parent.$eval(j.datepickerAppendToBody):k.appendToBody;h.showButtonBar=a.isDefined(j.showButtonBar)?h.$parent.$eval(j.showButtonBar):k.showButtonBar,h.getText=function(a){return h[a+"Text"]||k[a+"Text"]},j.$observe("datepickerPopup",function(a){o=a||k.datepickerPopup,p.$render()});var s=a.element("<div datepicker-popup-wrap><div datepicker></div></div>");s.attr({"ng-model":"date","ng-change":"dateSelection()"});var t=a.element(s.children()[0]);j.datepickerOptions&&a.forEach(h.$parent.$eval(j.datepickerOptions),function(a,b){t.attr(m(b),a)}),a.forEach(["minDate","maxDate"],function(a){j[a]&&(h.$parent.$watch(c(j[a]),function(b){h[a]=b}),t.attr(m(a),a))}),j.dateDisabled&&t.attr("date-disabled","dateDisabled({ date: date, mode: mode })"),p.$parsers.unshift(n),h.dateSelection=function(b){a.isDefined(b)&&(h.date=b),p.$setViewValue(h.date),p.$render(),q&&(h.isOpen=!1,i[0].focus())},i.bind("input change keyup",function(){h.$apply(function(){h.date=p.$modelValue})}),p.$render=function(){var a=p.$viewValue?f(p.$viewValue,o):"";i.val(a),h.date=n(p.$modelValue)};var u=function(a){h.isOpen&&a.target!==i[0]&&h.$apply(function(){h.isOpen=!1})},v=function(a){h.keydown(a)};i.bind("keydown",v),h.keydown=function(a){27===a.which?(a.preventDefault(),a.stopPropagation(),h.close()):40!==a.which||h.isOpen||(h.isOpen=!0)},h.$watch("isOpen",function(a){a?(h.$broadcast("datepicker.focus"),h.position=r?e.offset(i):e.position(i),h.position.top=h.position.top+i.prop("offsetHeight"),d.bind("click",u)):d.unbind("click",u)}),h.select=function(b){if("today"===b){var c=new Date;a.isDate(p.$modelValue)?(b=new Date(p.$modelValue),b.setFullYear(c.getFullYear(),c.getMonth(),c.getDate())):b=new Date(c.setHours(0,0,0,0))}h.dateSelection(b)},h.close=function(){h.isOpen=!1,i[0].focus()};var w=b(s)(h);s.remove(),r?d.find("body").append(w):i.after(w),h.$on("$destroy",function(){w.remove(),i.unbind("keydown",v),d.unbind("click",u)})}}}]),b.directive("datepickerPopupWrap",function(){return{restrict:"EA",replace:!0,transclude:!0,templateUrl:"/extensions/qWidget/components/wiDatePicker/template/popup.ng.html",link:function(a,b){b.bind("click",function(a){a.preventDefault(),a.stopPropagation()})}}})});