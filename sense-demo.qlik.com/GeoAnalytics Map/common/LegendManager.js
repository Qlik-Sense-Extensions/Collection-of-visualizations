define(["./Utils","./MathUtils","./ColorManager"],function(d,b,a){var g=$(window);var f=$(document);(function(h){h.fn.longclick=function(l,j){var i="touchstart";var k="touchend touchcancel";h(this).bind(i,function(m){var o=m;var n=window.setTimeout(function(){l(o)},j);f.bind(k,function(){window.clearTimeout(n);f.unbind(k);return true});return true})}})(jQuery);function c(o,n,k,m){var l=n.scrollTop();var j=n.prop("scrollHeight");var i=l+o;var h=n.height();if(h>=j){return}if(i>=j-h){i=j;m.prop("disabled",true)}else{m.prop("disabled",false)}if(i<=0){i=0;k.prop("disabled",true)}else{k.prop("disabled",false)}n.stop().animate({scrollTop:i,duration:100})}var e={legendHeight:60,legendWidth:0,initLegend:function(l){var i;if(!d.qlikview){i=l.extension.backendApi}$(".loadInfo",l.element).remove();d.clearErrorInLegend(l);this.legendWidth=(l.element.width()-20)/2;var j=$("<div>").attr("id","legend-menu-"+l.id).addClass("legend-menu idevio-hidden");var m=$("<label>").attr("for",l.id+"-visible").append($("<input>",{type:"checkbox",id:l.id+"-visible",checked:l.visible}).change(function(){l.setVisible(!l.visible)})).append($("<span>").html("Visible"));var k=$("<label>").attr("for",l.id+"-select").append($("<input>",{type:"checkbox",id:l.id+"-select",checked:l.controlSelect}).change(function(q){l.controlSelect=!l.controlSelect;if(d.qlikview){var n=d.layers[l.id].extension;var p=n.propertyMapping.selectable;n.Layout.SetProperty(p,(l.controlSelect===true)?1:0,true)}else{var o=l.extension.backendApi;o.getProperties().then(function(r){r.selectable=l.controlSelect;o.setProperties(r)})}if(q.currentTarget.checked){if(l.layer){l.layer.setPickable(true)}}else{if(l.layer){l.layer.setPickable(false)}}})).append($("<span>").html("Selectable"));var h=$("<div>").attr("id","legend-info-"+l.id).addClass("legend-info").on("click",function(q){f.on("mousedown.menu touchstart.menu",function(s){if(!$(s.target).parents().filter("#legend-menu-"+l.id).length){j.addClass("idevio-hidden");f.off("mousedown.menu touchstart.menu")}return true});var o=q.pageX;var r=q.pageY;var p=j.outerWidth();var n=j.outerHeight();if(o+p>g.width()){o-=p}if(r+n>g.height()){r-=n}if($(".qv-mode-edit").length!==1){j.toggleClass("idevio-hidden");j.offset({left:o,top:r})}if(!d.qlikview){if(!i.isSnapshot){j.toggleClass("idevio-hidden");j.offset({left:o,top:r})}if(($(".qv-snapshot-enabled").length===0)){j.toggleClass("idevio-hidden");j.offset({left:o,top:r})}}$(this).parent().find("#"+l.id+"-visible").prop("checked",l.visible)});l.element.css("overflow","visible");h.longclick(function(){j.toggleClass("idevio-hidden");j.css({left:"10px",top:"10px"})},1000);j.append(m,k);l.element.append(h,j);l.legendInit=true},createColorBar:function(h,k,j,o){if(document.documentMode&&document.documentMode<10){return this.createColorBarIE(h,k,j,o)}var p=o?"to right":"to top";o=o||$("<div>").addClass("legend-colorbar");var r="";var q=100/(h.length-(k?1:0));var l=0;var n=j&&j.length===h.length;for(var m=0;m<h.length;m++){r+=h[m]+" "+l+"%";l=n?(j[m+1]*100):Math.min(100,q+l);if(!k){r+=","+h[m]+" "+l+"%"}if(m<h.length-1){r+=","}}return o.attr("style","background: linear-gradient("+p+","+r+");")},createColorBarIE:function(h,k,j,q){var o=a.hash(h.join()+k+(j?j.join():"")+(q?"d":""));var r="lg"+o;var p='<svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" version="1.0" width="100%" height="100%" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient id="'+r+'" spreadMethod="pad" x1="0%" y1="100%"'+(q?' x2="100%" y2="100%"':' x2="0%" y2="0%"')+">";var s=100/(h.length-(k?1:0));var l=0;var n=j&&j.length===h.length;for(var m=0;m<h.length;m++){p+='<stop offset="'+l+'%" stop-color="'+h[m]+'" stop-opacity="1"/>';l=n?(j[m+1]*100):Math.min(100,s+l);if(!k){p+='<stop offset="'+l+'%" stop-color="'+h[m]+'" stop-opacity="1"/>'}}q=q||$("<div>").addClass("legend-colorbar");p+='</linearGradient></defs><rect width="100%" height="100%" style="fill:url(#'+r+');" /></svg>';return q.html(p)},createColorBlock:function(h){return $("<div>").addClass("legend-colorbar").css("background",h)},createColorLegend:function(n,h,o,p,ae){ae=ae||{};var w=h.color.mode==="byMeasure";var s=a.isSchemeSingleColor(h);var G=a.isSchemeGradient(h);var B=a.isByMeasure(h);var I=a.isByDimension(h);var z=a.isByExpression(h);var E=d.qlikview?h.qInfo.qType==="ideviochartlayer":h.visualization==="ideviochartlayer";var M=E?1:0;if(d.qlikview&&h.color.auto&&E){I=true;B=false;s=false;z=false;G=false;w=false}else{if(!d.qlikview&&h.color.auto){if(E){I=true;B=false;s=false;z=false;G=false}else{I=false;B=false;s=true;z=false}}}if(s||z||(B&&!w)||(!d.qlikview&&B&&h.qHyperCube.qDimensionInfo[M]&&h.qHyperCube.qDimensionInfo[M].qAttrExprInfo.length<1)){return}var W=$("<div>").addClass("legend-color");var u=d.qlikview?o[p-1]:h.qHyperCube.qDimensionInfo[M].qAttrExprInfo[0];var O=u&&!isNaN(u.qMin)&&u.qMin===u.qMax;var R=a.getColorScheme(h,true);var t=d.getValue(h,"legend.colors.auto",true);var v=t||d.getValue(h,"legend.colors.showColors",true);var K=t||d.getValue(h,"legend.colors.showTitle",true);var N=t||d.getValue(h,"legend.colors.showMinMax",true);var V=n.height();var af=d.qlikview?V-20:V-30;var S=Object.keys(ae).length>0?Object.keys(ae).length:R.length;var q=(n.find(".legend-size").width()||0)+85;var L=I?(50+4*15):((S+2)*10*1.25);var m=V>=L&&n.width()>=q;var Y=u?u.label||u.qFallbackTitle:"";var Q=Y;if(!d.getValue(h,"legend.colors.auto",true)){Q=d.getValue(h,"legend.colorTitle")||Y}var T;var C;var D;var aa;var F;var r;function l(){return/^((?!chrome).)*safari/i.test(navigator.userAgent)}if(B&&!G&&m){D=$("<div>").addClass("legend-colorbar-classes flex flex-column-reverse justify-space-around");if(v){if(document.documentMode&&document.documentMode<11||l()){W.css("max-height",(L*2)+"px")}else{D.css("max-height",(L*2)+"px")}var k=d.getValue(h,"color.autoMinMax",false);var ac=k?u.qMin:d.getValue(h,"color.measureMin",u.qMin);var A=k?u.qMax:d.getValue(h,"color.measureMax",u.qMax);var H=(A-ac)/R.length;var y=ac;var j=Math.min((L*2),V-20);T=j/S;C=0;for(var X=0;X<R.length;X++){if(Object.keys(ae).length===0||ae[String(X)]){var ad=b.formatNumberForDisplay(y)+" - <"+b.formatNumberForDisplay(y+H);if(!k&&X===0){ad="<"+b.formatNumberForDisplay(y+H)}else{if(!k&&X===R.length-1){ad=">"+b.formatNumberForDisplay(y)}}if(document.documentMode&&document.documentMode<11||l()){D.append($("<div>").append($("<span>").css({position:"absolute",right:"22px",bottom:(C)+"px"}).html(ad)),$("<div>").addClass("color-box").css({background:R[X],position:"absolute",right:"5px",bottom:(C)+"px"}));C+=T}else{D.append($("<div>").addClass("flex flex-row justify-flex-end").append($("<span>").html(ad),$("<div>").addClass("color-box").css("background",R[X])))}}y+=H}}if(K){$("<span>").addClass("color-title").html(Q).appendTo(D)}W.append(D)}else{if(v&&I&&m){var ab=$("<div>").addClass("flex flex-column align-flex-end legend-colorbar-dimensions");T=20;C=8;if(document.documentMode&&document.documentMode<11||l()){D=$("<div>").addClass("legend-color-list").css({"max-height":V-20,position:"relative"})}else{D=$("<div>").addClass("flex flex-column legend-color-list")}Object.keys(ae).forEach(function(i){var ag=i.substr(i.length-100);if(document.documentMode&&document.documentMode<11||l()){D.append($("<div>").append($("<span>").css({position:"absolute",right:"22px",top:C+"px","white-space":"nowrap"}).html(ag),$("<div>").addClass("color-box").css({background:ae[i],position:"absolute",right:"5px",top:C+"px"})));C+=T}else{D.append($("<div>").addClass("flex flex-row justify-flex-end").append($("<span>").html(ag),$("<div>").addClass("color-box").css("background",ae[i])))}});ab.append(D);if(document.documentMode&&document.documentMode<11||l()){aa=$("<div>").addClass("flex flex-row justify-space-around legend-colorbar-listbuttons").css({position:"absolute",bottom:"0px",right:"0px"})}else{aa=$("<div>").addClass("flex flex-row justify-space-around legend-colorbar-listbuttons")}if(d.qlikview){F=$("<button>").addClass("sc-scroll-button-up").prop("disabled",true);r=$("<button>").addClass("sc-scroll-button-down")}else{F=$("<button>").addClass("qui-plainbuttonicon").attr("data-icon","R").prop("disabled",true);r=$("<button>").addClass("qui-plainbuttonicon").attr("data-icon","S")}F.on("click touchstart",function(i){c(-af,D,F,r);i.stopPropagation()});r.on("click touchstart",function(i){c(af,D,F,r);i.stopPropagation()});aa.append(r,F);ab.append(aa);W.append(ab);D.on("onwheel" in document?"wheel":"onmousewheel" in document?"mousewheel":"DOMMouseScroll",function(ag){ag.preventDefault();var ah;if(event.wheelDelta){ah=(event.wheelDelta%120-0)===-0?event.wheelDelta/120:event.wheelDelta/12}else{var i=event.deltaY?event.deltaY:event.detail;ah=-(i%3?i*10:i/3)}c(-ah*60,D,F,r)})}else{if(v&&(!O||I)){W.append(this.createColorBar(R,G))}else{if(O){W.append(this.createColorBlock(R[Math.floor(R.length/2)]))}}if(w&&(a.isByMeasure(h)||h.color.auto)){ae=$("<div>").addClass("color-info").appendTo(W);if(K){ae.append($("<span>").addClass("color-title").html(Q))}if(N&&u){var P;if(u.qMax!==u.qMin){var J=d.getValue(h,"color.autoMinMax",false);P=isNaN(u.qMin)?"":b.formatNumberForDisplay(u.qMin);var Z=isNaN(u.qMax)?"":b.formatNumberForDisplay(u.qMax);if(!J){var U=h.color.measureMin;var x=h.color.measureMax;if(!isNaN(U)){P="<"+b.formatNumberForDisplay(U)}if(!isNaN(x)){Z=">"+b.formatNumberForDisplay(x)}}ae.append($("<span>").addClass("color-info-max").html(Z));ae.append($("<span>").addClass("color-info-min").html(P))}else{if(u.qMax===u.qMin){P=isNaN(u.qMin)?"":b.formatNumberForDisplay(u.qMin);ae.append($("<span>").addClass("color-info-single")).html(P)}}}}}}n.append(W);if(v&&I&&m){if(D.height()>=D.prop("scrollHeight")){r.prop("disabled",true)}}},createBubblesForLegend:function(z,l,s,F){var h=z.min;var k=z.max;var t=z.minradius;var n=z.maxradius;var A;this.legendHeight=l;var u=k-h;if(isNaN(u)){u=0}var r,p;if(u<=0){r=p=Math.floor((t+n)/2)}else{r=Math.floor(n);p=Math.floor(t)}var C=5;var x=((this.legendHeight/r)>2)?Math.floor((this.legendHeight+r/1.5)/(((r*2)+(p*2))/2+C)):2;var o=[];var D=0;for(A=0;A<x;A++){o[A]=(p+((r-p)/(x-1))*(A));if(A!==0&&A!==(x-1)){D+=(o[A]*2)}}o=o.reverse();var m=$("<canvas>").attr({id:"bubbleCanvas",width:((r)?r*2+21:this.legendWidth),height:this.legendHeight});var y=m.get(0).getContext("2d");var j=d.POLYGONS[s.geometry.shape];if(s.geometry.shape==="bars"){var v;if(!r||!p){v=s.bars.maxHeight}else{v=r*2}this.createRectangleBarHTML(5,(this.legendHeight/2)-(v/2),s.barwidth,v,y,s,F)}else{if(this.legendHeight>62&&r>p){this.createRegularPolygonHTML(15,0,r,y,s,j,F);this.createRegularPolygonHTML(15,this.legendHeight-p,p,y,s,j,F);var w=this.legendHeight-r-(p*2);var B=(w-D)/(o.length-1);var q=0;for(A=1;A<o.length-1;A++){q+=B+o[A]+o[A-1];this.createRegularPolygonHTML(15,q,o[A],y,s,j,F)}}else{var E;if(!r||!p){E=(s.Radius.max.value+s.Radius.min.value)/2;this.createRegularPolygonHTML(15,this.legendHeight/2,E,y,s,j,F)}else{if(r<=p){E=(s.Radius.max.value+s.Radius.min.value)/2;this.createRegularPolygonHTML(15,this.legendHeight/2,E,y,s,j,F)}else{this.createRegularPolygonHTML(15,(this.legendHeight<(r)+(p*2))?this.legendHeight-(p*2)-r:0,r,y,s,j,F);this.createRegularPolygonHTML(15,this.legendHeight-(p+1),p,y,s,j,F)}}}}return m},createRegularPolygonHTML:function(s,q,n,t,p,o,j){if(n<=0){return}var h=p.color.outline||"262626";var k;if(j){k=a.getPrimaryColor(p)}else{k="#CCCCCC";h="#262626"}t.beginPath();if(o.sides<3){t.arc(s,q,n,0,Math.PI*2)}else{var r=((Math.PI*2)/o.sides);var m=o.rotation;t.translate(s,q);t.rotate(m);t.moveTo(n,0);for(var l=1;l<o.sides;l++){t.lineTo(n*Math.cos(r*l),n*Math.sin(r*l))}t.closePath();t.rotate(-m);t.translate(-s,-q)}t.fillStyle=k;t.fill();t.lineWidth=1.2;t.strokeStyle=h;t.stroke()},createRectangleBarHTML:function(n,m,j,o,p,l,i){var h=l.color.outline||"262626";var k;if(i){k=a.getPrimaryColor(l)}else{k="#CCCCCC";h="#262626"}p.beginPath();p.rect(n,m,j,o);p.fillStyle=k;p.fill();p.lineWidth=1.2;p.strokeStyle=h;p.stroke()},createLinesForLegend:function(x,k,o,D){var l=x.max;var h=x.min;var u=x.minwidth;var A=x.maxwidth;var y;this.legendHeight=$(k).height();var t=l-h;if(isNaN(t)){t=0}var s,q;if(t<=0){s=q=Math.floor((u+A)/2)}else{s=Math.floor((l-h)/t*(A-u)+u);q=Math.floor((h-h)/t*(A-u)+u)}var B=10;var C=Math.floor((this.legendHeight+s)/(((s+q)/2)+B));var j=[];var p=0;for(y=0;y<C;y++){j[y]=q+((s-q)/(C-1))*y;if(y!==0&&y!==(C-1)){p+=j[y]}}j.reverse();var m=$("<canvas>").attr({id:"lineCanvas",width:45,height:this.legendHeight});var w=m.get(0).getContext("2d");var r;if(!s||!q){r=(o.Width.max.value+o.Width.min.value)/2;this.createHTMLRect(0,(this.legendHeight/2)-(r/2),30,r,w,o,D)}else{if(s>q){this.createHTMLRect(0,0,30,s,w,o,D);this.createHTMLRect(0,this.legendHeight-q-1,30,q,w,o,D);var v=this.legendHeight-s-q-1;var z=(v-p)/(j.length-1);var n=0;for(y=1;y<j.length-1;y++){n+=z+j[y-1];this.createHTMLRect(0,n,30,j[y],w,o,D)}}else{r=(o.Width.max.value+o.Width.min.value)/2;this.createHTMLRect(0,(this.legendHeight/2)-(r/2),30,r,w,o,D)}}return m},createHTMLRect:function(i,o,m,h,l,k,n){var j;if(n){j=a.getPrimaryColor(k)}else{j="#CCCCCC"}l.beginPath();l.rect(i,o,m,h);l.fillStyle=j;l.fill()},fixSizeForIcon:function(n){var m=60;var h=$("#legend-info-"+n)[0].clientHeight;var j=$("#legend-info-"+n)[0].clientWidth;var i=(h>j)?j:h;var k=((i>m)?m:i)/2;var l=(m/2-k)/2;$("#legend-info-"+n).css({"background-size":k+"px",left:l})},fixHeightForLegend:function(j){var i=this.fixHeightForDataLegend(j);var h=this.fixHeightForColorLegend(j);if(i||h){$("div#legend-info-"+j+" .data-info-max").remove();$("div#legend-info-"+j+" .data-info-min").remove();$("div#legend-info-"+j+" .color-info-max").remove();$("div#legend-info-"+j+" .color-info-min").remove()}},fixHeightForDataLegend:function(l){var h=$("div#legend-info-"+l+" .legend-data-info");var j=$("#legend-info-"+l+" .data-info-title");var i=$("#legend-info-"+l+" .data-info-max");var k=$("#legend-info-"+l+" .data-info-min");if(!j[0]||!i[0]||!k[0]){return false}if(j[0].clientHeight&&i[0].clientHeight&&k[0].clientHeight){if(j[0].clientHeight+i[0].clientHeight+k[0].clientHeight>h[0].clientHeight+13){return true}}return false},fixHeightForColorLegend:function(l){var h=$("div#legend-info-"+l+" .color-info");var j=$("#legend-info-"+l+" .color-title");var k=$("div#legend-info-"+l+" .color-info-max");var i=$("div#legend-info-"+l+" .color-info-min");if(!j[0]||!k[0]||!i[0]){return false}if(j[0].clientHeight&&k[0].clientHeight&&i[0].clientHeight){if(j[0].clientHeight+k[0].clientHeight+i[0].clientHeight>h[0].clientHeight+13){return true}}return false},fixWidthForLegend:function(s){var l=$("#legend-info-"+s);var v=$("#legend-info-"+s+" .data-info-title")[0]?$("#legend-info-"+s+" .data-info-title"):false;var D=$("#legend-info-"+s+" .color-title")[0]?$("#legend-info-"+s+" .color-title"):false;var u=$("#legend-info-"+s+" .legend-color-list")[0]?$("#legend-info-"+s+" .legend-color-list"):false;var B=false;var m=false;var n=false;if(v||D){var A=(v)?parseFloat(v.css("font-size")):0;var x=(D)?parseFloat(D.css("font-size")):0;var j=Math.max(A,x);while(l[0].clientWidth<(v?v[0].clientWidth:0)+(D?D[0].clientWidth:0)+85&&j>10){if(v&&A>10){v.css("font-size",j-1)}if(D&&x>10){D.css("font-size",j-1)}j--}while(l[0].clientWidth<(v?v[0].clientWidth:0)+(D?D[0].clientWidth:0)+85+(u?(u[0].clientWidth>40?20:u[0].clientWidth-20):0)){if(v&&(v.text().length>(D?D.text().length:0))){v.text(v.text().substr(0,v.text().length-1));B=true}else{D.text(D.text().substr(0,D.text().length-1));m=true}if(((v?v[0].clientWidth===0:true)&&(D?D[0].clientWidth===0:true))||((v?v.text().length===0:true)&&(D?D.text().length===0:true))){break}}if(B){v.text(v.text().substr(0,v.text().length-3)+"...")}if(m){D.text(D.text().substr(0,D.text().length-3)+"...")}if(B&&v&&v.text().length<5){v.remove();n=true}if(m&&D&&D.text().length<5){D.remove();n=true}}var r=($("#legend-info-"+s+" .legend-colorbar").length)?$("#legend-info-"+s+" .legend-colorbar"):false;var q=($("#legend-info-"+s+" .color-info-max").length)?$("#legend-info-"+s+" .color-info-max"):false;var o=($("#legend-info-"+s+" .color-info-min").length)?$("#legend-info-"+s+" .color-info-min"):false;if(q&&o){var w=q.offset().left-(q[0].clientWidth+7);var h=$("#legend-info-"+s+" .data-info-max")[0]?$("#legend-info-"+s+" .data-info-max").offset().left:0;if(w<h){q.remove();o.remove()}}var i=l[0].clientWidth-((v?v[0].clientWidth:0)+(D?D[0].clientWidth:0)+85);var z=($("#legend-info-"+s+" .legend-colorbar-classes").length)?$("#legend-info-"+s+" .legend-colorbar-classes"):false;var k=($("#legend-info-"+s+" .legend-colorbar-dimensions").length)?$("#legend-info-"+s+" .legend-colorbar-dimensions"):false;if((z&&z[0].clientWidth>l[0].clientWidth-30)||(k&&k[0].clientWidth>l[0].clientWidth-30)){if(z){z[0].style.width=i+"px"}if(k){k[0].style.width=i+"px"}}if(r){var t=($("#legend-info-"+s+" .color-info").length)?$("#legend-info-"+s+" .color-info"):false;var p=($("#legend-info-"+s+" #bubbleCanvas").length)?$("#legend-info-"+s+" #bubbleCanvas"):false;var y=($("#legend-info-"+s+" #lineCanvas").length)?$("#legend-info-"+s+" #lineCanvas"):false;if((p&&(p[0].clientWidth+r[0].clientWidth)>l[0].clientWidth-20)){if(r){r.remove()}if(t){t.remove()}}if(y&&(y[0].clientWidth+r[0].clientWidth)>l[0].clientWidth-20){if(r){r.remove()}if(t){t.remove()}}if((!y&&!p)&&(r[0].clientWidth+25)>(l[0].clientWidth-30)){if(r){r.remove()}if(t){t.remove()}var C=20;$("#legend-info-"+s).css({"background-size":C,left:15-(C/2)})}}},fixWidthForTitle:function(n){if(!$("#legend-info-"+n+" .legend-title")[0]){return}var i=$("#legend-info-"+n+" .legend-title");var l=$("#legend-info-"+n);var k=parseFloat(i.css("font-size"));while(i[0].clientWidth>(l[0].clientWidth-45)&&k>10){i.css("font-size",k--)}var m=false;while(i[0].clientWidth>(l[0].clientWidth-45)){m=true;i.text(i.text().substr(1,i.text().length));if(i[0].clientWidth===0){break}}if(m){i.text("..."+i.text().substr(3,i.text().length))}var j=false;if(i.text().length<(m?5:2)){i.remove();j=true}if(j){var h=20;$("#legend-info-"+n).css({"background-size":h,left:15-(h/2)})}},dimLegend:function(h,j){if(d.getValue(d.layers,h+".layout.qInfo.qType")==="masterobject"){return}var i=$("#legend-info-"+h);var k=$("#dim-"+h);if(j){if(k.length===0){k=$("<canvas>").addClass("dim").attr("id","dim-"+h).appendTo(i)}}else{k.remove()}},autoDimAllLegends:function(){for(var i in d.layers){var h=d.layers[i];if(!h){continue}this.dimLegend(h.id,!h.isVisible())}}};return e});