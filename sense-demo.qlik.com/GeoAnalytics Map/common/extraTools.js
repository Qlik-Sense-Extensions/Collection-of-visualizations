define(["./MathUtils","./MapUtils","./Utils"],function(c,a,d){window.idevio=window.idevio||{};idevio.Connection=idevio.Connection||{};idevio.Connection.delayedInit=idevio.Connection.delayedInit||[];idevio.Connection.delayedInit.push(function b(){window.idevio.map.BoxSelectTool=(function(f){var h=[];var i=0;var g=0;var e=0;var k=0;function j(n,o,l,m){f.call(this);this._type=l||"lasso";this._dataset=n;this._callback=o;this._drawListId=null;this._maplayer=m}f.__extend(j);j.prototype._distanceFromStart=function(l,m){return c.hypot(this._startEvent.clientX-l,this._startEvent.clientY-m)};j.prototype._distanceBetweenPoints=function(m,o,l,n){return c.hypot(m-l,o-n)};j.prototype._connecting=function(){this._addListener("click",function(l){if(!l.shiftKey){this._click(l)}});this._addListener("press",function(l){this._map.setInteracting(true);if(l.button===0&&l.shiftKey){this._start(l)}else{if(this._maplayer.toggleLasso){this._maplayer.toggleLassoFunc(this._maplayer);this._start(l)}}});this._addListener("dblclick",function(l){this._doubleClick(l)}.bind(this))};j.prototype.setType=function(l){this._type=l.toLowerCase()};j.prototype._start=function(m){if(this._type){var n=this._maplayer.map.getDiv();h=[];i=0;g=0;e=n.clientWidth;k=n.clientHeight;var l;if($("#drawCanvas").length<=0){l=a.addDrawingCanvas(this._maplayer);l.ignoreButton=true}}m.preventDefault()};j.prototype._doubleClick=function(n){if(n.target){var o=n.target.getAttribute("elemNumber");var m=d.layers[n.target.getDataset().getName()];var l=this._maplayer;if(d.qlikview){m.extension.Data.SelectTextsInColumn(0,false,[o])}else{if(!m.editMode){m.extension.backendApi.selectValues(0,[o],false)}}d.resetAllInfoBubbleTools();a.cancelSelection(l)}};j.prototype._draw=function(m,o){this._startEvent=o._startEvent;this._endEvent=o._endEvent;if(!this._startEvent||!this._endEvent){return}var l=this._maplayer.map;var z=$(o).offset().left;var w=$(o).offset().top;var C=o.getContext("2d");var p=this._startEvent.pageX-z;var n=this._startEvent.pageY-w;var D=this._endEvent.pageX-p-z;var B=this._endEvent.pageY-n-w;var t=this._endEvent.pageX-z;var r=this._endEvent.pageY-w;i=(i>t)?i:t;g=(g>r)?g:r;e=(e<t)?e:t;k=(k<r)?k:r;C.beginPath();C.strokeStyle="black";if(this._type==="box"){C.lineWidth=2;C.rect(p,n,D,B);C.stroke()}else{if(this._type==="circle"){var u=c.hypot(p-t,n-r);C.arc(p,n,u,0,2*Math.PI,false);C.stroke();var v=Math.round(l.getDistanceInMeters([p,n],[t,r]));var A="m";if(this._maplayer.properties.useImperialUnitsScaleBar){A="ft";if(v>5280){v/=5280;A="mi";v=v.toFixed(v<10?1:0)}}else{if(v>1000){v/=1000;A="km";v=v.toFixed(v<10?1:0)}}var q=v+A;C.fillStyle="black";C.font="bold 11pt sans-serif";C.textAlign="center";C.textBaseline="middle";C.strokeStyle="white";C.lineWidth=1.5;C.strokeText(q,p,n);C.fillText(q,p,n)}else{if(this._type==="lasso"){C.arc(p,n,8,0,2*Math.PI,false);C.fillStyle="#00bb00";C.fill();C.strokeStyle="#00bb00";C.stroke();C.beginPath();C.moveTo(p,n);for(var s=0;s<h.length;s++){C.lineTo(h[s][0],h[s][1])}if(h[0]){var v=c.hypot(h[0][0]-t,h[0][1]-r);if(v<100){window.CanvasRenderingContext2D.prototype.dashedLine=function(E,K,y,J,H){if(typeof H==="undefined"){H=2}this.moveTo(E,K);var G=y-E;var F=J-K;var I=Math.floor(Math.sqrt(G*G+F*F)/H);var M=G/I;var L=F/I;var x=0;while(x++<I){E+=M;K+=L;this[x%2===0?"moveTo":"lineTo"](E,K)}this[x%2===0?"moveTo":"lineTo"](y,J)};C.dashedLine(t,r,p,n,3)}}C.strokeStyle="dimgray";C.lineWidth=2;C.stroke();h.push([t,r])}}}m.preventDefault()};j.prototype._click=function(m){if(this._callback){var l=["click"];if(m&&m.target){l.push(m.target)}this._callback(l)}};j.prototype._release=function(m,p){var n=this._maplayer.map;this._map.setInteracting(false);m.preventDefault();if(this._startEvent){var l=[];if(!this._endEvent){if(this._startEvent.target){l.push(this._startEvent.target)}}else{if(this._type==="box"){l=n.getFeaturesWithin(Math.min(m.pageX-p.x,this._startEvent.pageX-p.x),Math.min(m.pageY-p.y,this._startEvent.pageY-p.y),Math.max(m.pageX-p.x,this._startEvent.pageX-p.x),Math.max(m.pageY-p.y,this._startEvent.pageY-p.y))}else{if(this._type==="circle"){var r=n.getDiv();var q=this;l=n.getFeaturesWithin(0,0,r.clientWidth,r.clientHeight).filter(function(G){function E(J){var H=q._startEvent.pageX-p.x;var I=q._startEvent.pageY-p.y;return q._distanceBetweenPoints(H,I,J[0],J[1])<q._distance}var D=G.getCoordinates();if(Array.isArray(D[0])&&Array.isArray(D[0][0])){var C=[];for(var z=0;z<D.length;z++){C[z]=[];for(var y=0;y<D[z].length;y++){if(E(n.geoToDisplay(D[z][y]))){return true}C[z].push(n.geoToDisplay(D[z][y]))}}for(var w=0;w<C.length;w++){if(c.pointInPolygon(q._startEvent.clientX,q._startEvent.clientY,C[w])){return true}}}else{if(Array.isArray(D[0])){var x=q._startEvent.clientX-p.x;var v=q._startEvent.clientY-p.y;var t=q._distance;for(var u=0;u<D.length;u++){var s=n.geoToDisplay(D[u])[0];var F=n.geoToDisplay(D[u])[1];var B=n.geoToDisplay(D[Math.min(u+1,D.length-1)])[0];var A=n.geoToDisplay(D[Math.min(u+1,D.length-1)])[1];if(c.lineCircleIntersect(s,F,B,A,x,v,t)){return true}}}else{if(!Array.isArray(D[0])){return E(n.geoToDisplay(D))}}}})}else{if(this._type==="lasso"){var o=c.hypot(h[0][0]-h[h.length-1][0],h[0][1]-h[h.length-1][1]);if(o<100){l=n.getFeaturesWithin(e,k,i,g).filter(function(F){var C=F.getCoordinates();var A=[];if(Array.isArray(C[0])&&Array.isArray(C[0][0])){for(var x=0;x<C.length;x++){A[x]=[];for(var w=0;w<C[x].length;w++){A[x].push(n.geoToDisplay(C[x][w]));if(c.pointInPolygon(A[x][w][0],A[x][w][1],h)){return true}}}for(var v=0;v<h.length;v++){for(var u=0;u<A.length;u++){if(c.pointInPolygon(h[v][0],h[v][1],A[u])){return true}}}}else{if(Array.isArray(C[0])){for(var t=1;t<C.length;t++){var E=n.geoToDisplay(C[t-1]);var D=n.geoToDisplay(C[t]);for(var s=1;s<h.length;s+=1){var B=h[s-1];var z=h[s];if(c.linesIntersect(E,D,B,z)){return true}}}}}var y=n.geoToDisplay(F.getCenter());return c.pointInPolygon(y[0],y[1],h)})}}}}}if(l.length>0){if(this._dataset){l=l.filter(function(s){return s.getDataset()===q._dataset})}if(this._callback){this._callback(l)}}this._endEvent=this._startEvent=null;n.repaint()}};return j})(window.idevio.map.Tool)})});