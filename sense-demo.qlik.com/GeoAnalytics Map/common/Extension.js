define(["./Utils","./LegendManager","./ColorManager","module"],function(d,e,a,b){var c;if(b.config().testing){c=function(g){g()}}else{c=window.setTimeout}function f(i,k,j,g,h){h=h||{};this.name=i||"Layer";this.extension=k;this.element=g;this.id=j.qInfo.qId;this.layout=j;this.editMode=Boolean(k.editMode);this.visible=Boolean(j.visible);this.isStatic=Boolean(h.isStatic);this.numCoordinates_=2;this.map=null;this.logger=null;this.layer=null;this.colorInfo_={};this.initialized=false;d.layers[this.id]=this;if(!d.qlikview){d.addSpinner(this.element)}c(function(){this.waitForMapExtension()}.bind(this),0)}f.extend=function(g){for(var i in this){if(this.hasOwnProperty(i)){g[i]=this[i]}}function h(){this.constructor=g}h.prototype=this.prototype;g.prototype=new h()};f.prototype.waitForMapExtension=function(){if(d.getValue(this.layout,"qInfo.qType")==="masterobject"||this._isSettingMapId){return}var h=d.getValue(this,"layout.mapid");if(!h){var j=Object.keys(d.maps);if(j.length===0){d.setErrorInLegend(this,"No GeoAnalytics Map added to sheet. Please add an GeoAnalytics Map.",false);return}else{var k=this;var g=this.extension.backendApi;this._isSettingMapId=true;g.getProperties().then(function(m){delete k._isSettingMapId;var l=d.getMostRecentMapId();m.mapid=l;g.setProperties(m).then(function(){k.init(d.maps[l])})})}}else{var i=d.maps[h];if(i){this.init(i)}else{if(!this.hasWaitedForMap){this.hasWaitedForMap=true;c(function(){if(!this.initialized){d.setErrorInLegend(this,"Could not find a map with the ID specified in Layer Options",false)}}.bind(this),4000)}}}};f.prototype.init=function(g){if(this.initialized){return}this.ensureBackCompat();this.initialized=true;this.controlSelect=this.isStatic?false:this.layout.selectable;this.dimension=function(){var h=d.getValue(this.layout,"qHyperCube.qDimensionInfo.0");if(h&&h.qGrouping==="H"){return h.qGroupFieldDefs[h.qGroupPos]}else{if(h){return h.qGroupFieldDefs[0]}else{return""}}}.bind(this);this.extension.destroy=this.destroy.bind(this);this.extension.on=this.on.bind(this);this.extension.off=this.off.bind(this);this.extension.prePaint=function(h){if(!d.getValue(this.extension,"options.isVisible",true)){this.paintExtension(h,true,false)}}.bind(this);this.initLegend();this.setMap(g);this.repaint()};f.prototype.setMap=function(g){this.clearLayer(true);if(this.logger){this.logger.clearErrorsForLayer(this.id)}this.map=g;this.logger=null;if(g){this.logger=this.map.logger;d.clearErrorInLegend(this);this.layerInit()}};f.prototype.layerInit=function(){this.layer=new idevio.map.FeatureLayer(this.map.map,{name:this.layerTitle,visible:this.visible,dataset:this.dataset,pickable:this.controlSelect,minRes:d.getValue(this.layout,"inResolutionLimit.value",0),maxRes:d.getValue(this.layout,"outResolutionLimit.value",99999999),drawOrder:d.getDrawOrder(this.layout),styles:[],meta:{qvlayer:this}})};f.prototype.clearLayer=function(g){if(this.layer){if(this.layer.setDataset){this.layer.getDataset().removeAll()}if(g){this.layer.remove();this.layer=null}}};f.prototype.repaint=function(g){this.paintExtension(this.layout,g,false)};f.prototype.initLegend=function(){if(!this.legendInit||this.element.find(".legend-info").length===0){this.element.empty();e.initLegend(this)}};f.prototype.paintExtension=function(h,l,j){this.layout=h;if(d.getValue(this.layout,"qInfo.qType")==="masterobject"){this.paintAsMasterItem();return}if(!d.getValue(this.extension,"options.isVisible",true)&&!l){return}if(!this.map||!this.layer){if(!this.initialized){this.waitForMapExtension()}return}if(this.initialized&&!d.maps[this.layout.mapid]){this.element.empty();d.setErrorInLegend(this,"Could not find a map with the ID specified in Layer Options",false);return}this.initLegend();try{this.calcDataSourceIndex();var k=this.prepare();if(k===true){return}this.prePaint(d.getValue(this.layout,"qHyperCube.qDataPages",[]));if(this.layer.setName&&h.title){this.layer.setName(h.title)}this.layer.setVisible(this.visible);this.layer.setPickable(this.controlSelect);this.layer.setMinRes(this.layout.inResolutionLimit.value);this.layer.setMaxRes(this.layout.outResolutionLimit.value);d.setDrawOrder(this.layout);this.colorInfo_={};c(function(){try{this.paintLegend()}catch(m){window.console.log(m.stack,m,m.message);this.addError("legendCreationError","Error creating legend: "+(m.message?m.message:m))}}.bind(this),0);this.map.startWork(this.id,j);var i=this.layout.visualization==="ideviogeodatalayer"||this.layout.qInfo.qType==="ideviogeodatalayer";if(this.isVisible()||i){this.initPaint(l);e.dimLegend(this.id,false)}else{this.clearLayer(false);this.map.doneWorkViewBounds(this.id,null);e.dimLegend(this.id,true)}}catch(g){window.console.log(g.stack,g,g.message);this.addError("layerCreationError","Error creating layer: "+(g.message?g.message:g));this.logger.showErrors()}};f.prototype.paintAsMasterItem=function(){if(!this.initialized){this.map={};this.initialized=true}this.calcDataSourceIndex();this.prepare();if(this.isByDimension){this.colorInfo_={foo:"red",bar:"green",baz:"blue"}}else{this.colorInfo_={}}this.element.empty();e.initLegend(this);try{this.paintLegend()}catch(g){}};f.prototype.prepare=function(){this.isLocationIds=this.dsType==="LocationIds";this.layerTitle=this.layout.title||this.name;var g=d.getValue(this,"layout.qHyperCube.qMeasureInfo",[]);this.hasColorMeasure=this.colorSource_!==-1&&g.length>=this.colorSource_;this.isSingleColor=a.isSchemeSingleColor(this.layout)||d.getValue(this,"layout.color.auto")&&!this.hasColorMeasure;this.isColorExpression=a.isByExpression(this.layout);this.isColorFromMeasure=a.isByMeasure(this.layout)&&this.hasColorMeasure;this.isSchemeGradient=a.isSchemeGradient(this.layout);this.isByDimension=a.isByDimension(this.layout);return false};f.prototype.initPaint=function(g){d.requestData(this,function(h){this.paint(h);this.paintLegend()}.bind(this),g)};f.prototype.on=function(){this.editMode=false;this.extension._on=true};f.prototype.off=function(){this.editMode=true;this.extension._on=false};f.prototype.addError=function(g,h){if(this.logger){this.logger.addError(this.id,h)}};f.prototype.addWarning=function(g,h,j,i){if(this.logger){this.logger.addWarning(this.id,g,h,j,i)}};f.prototype.isVisible=function(){if(!this.map){return false}if(this.layout.qInfo.qType==="masterobject"){return true}var i=this.map.map.getResolution();var j=this.isRestrictedDrilldown();var h=!this.layer||(i>this.layer.getMinRes()&&i<this.layer.getMaxRes());var g=!j&&this.visible&&h;if(!this.isStatic){if(g){this.clearSoftPatch()}else{this.applySoftPatch()}}return g};f.prototype.setVisible=function(h){this.visible=h;if(h===true){if(this.isStatic){this.clearLayer(true)}else{this.clearLayer(false)}}var g=this.extension.backendApi;g.getProperties().then(function(i){i.visible=h;g.setProperties(i)});if(this.layer){this.layer.setVisible(h)}if(this.map){this.map.visibleLayerChanged()}};f.prototype.isRestrictedDrilldown=function(){return d.isRestrictedDrillDown(this.layout)};f.prototype.destroy=function(){this.clearLayer(true);if(this.map){this.logger.clearErrorsForLayer(this.id);this.map.doneWorkViewBounds(this.id,null)}delete d.layers[this.id]};f.prototype.prePaint=d.NOP;f.prototype.paint=d.NOP;f.prototype.paintLegend=d.NOP;f.prototype.calcDataSourceIndex=d.NOP;f.prototype.ensureBackCompat=function(k){var g=k||{};if(typeof this.layout.visible==="object"){g.visible=Boolean(this.layout.visible.value)}else{d.setIfUndefined(this.layout,"visible",g,true)}d.setIfUndefined(this.layout,"selectable",g,true);d.setIfUndefined(this.layout,"location.forceFileReload",g,true);d.setIfUndefined(this.layout,"infoBubble.visible",g,true);d.setIfUndefined(this.layout,"infoBubble.formatCustom",g,true);d.setIfUndefined(this.layout,"infoBubble.formatNumbers",g,true);d.setIfUndefined(this.layout,"infoBubble.formatNumbersAuto",g,true);d.setIfUndefined(this.layout,"infoBubble.formatNumberList",g,"");d.setIfUndefined(this.layout,"color.auto",g,true);d.setIfUndefined(this.layout,"color.mode",g,"primary");d.setIfUndefined(this.layout,"color.measureScheme",g,"sg");d.setIfUndefined(this.layout,"color.dimensionScheme",g,"12");d.setIfUndefined(this.layout,"color.alpha",g,1);var j=d.getValueFromLogScaleRevert(this.layout.inResolutionLimit.value,0,10000,0.1,160000);var i=d.getValueFromLogScaleRevert(this.layout.outResolutionLimit.value,0,10000,0.1,160000);d.setIfUndefined(this.layout,"resolutionLimit.range",g,[isFinite(j)?j:0,isFinite(i)?i:10000]);if(Object.keys(g).length>0){d.setProperties(this.id,g).then(this.fixColorSettings.bind(this));jQuery.extend(true,this.layout,g)}if(this.layout&&this.layout.draworder&&this.layout.visualization&&this.extension.backendApi&&this.layout.draworder.category==="ideviobubblelayer"&&this.layout.visualization!="ideviobubblelayer"&&this.layout.draworder.auto===true){var h=this.extension.backendApi;h.getProperties().then(function(l){l.draworder.category=l.visualization;h.setProperties(l)})}};f.prototype.fixColorSettings=function(k){var h=this.extension.backendApi;var i=false;var l=this.extension.$scope.ext.getCreatePropertyHandler();var g=function(n){var m=k.qHyperCubeDef.qDimensions[n];var o={label:m.qDef.qFieldLabels[0]||m.qDef.qFieldDefs[0],name:m.qDef.qFieldDefs[0],type:"dimension"};l.setProperties(k);l.setColorByDef(o);l.updateGlobalChangeListeners();h.setProperties(k);i=false}.bind(this);var j=function(n,m){var p=k.qHyperCubeDef.qMeasures[n];var o=p.qLibraryId?{type:"measure",name:p.qLibraryId,id:p.qLibraryId}:{label:p.qDef.qLabel||p.qDef.qDef,name:p.qDef.qDef,type:"expression"};l.setProperties(k);if(m){l.removeMeasure(n)}l.setColorByDef(o);l.updateGlobalChangeListeners();h.setProperties(k);i=false}.bind(this);if(k.visualization==="ideviochartlayer"){if(k.color.auto&&!k.color.byDimDef){}else{if(!k.color.auto&&k.color.mode==="byDimension"){g(1)}else{if(!k.color.auto&&k.color.mode==="byMeasure"&&!k.color.byMeasureDef&&this.colorSource_!==-1&&k.qHyperCubeDef.qMeasures.length>=this.colorSource_){j(this.colorSource_,false)}}}}else{if(!k.color.auto&&k.color.mode==="byMeasure"&&this.colorSource_!==-1&&k.qHyperCubeDef.qMeasures.length>=this.colorSource_&&!k.color.byMeasureDef){j(this.colorSource_-1,true)}else{if(k.color.auto&&this.colorSource_!==-1&&k.qHyperCubeDef.qMeasures.length>=this.colorSource_&&!k.color.byMeasureDef){j(this.colorSource_-1,true)}else{if(!k.color.auto&&k.color.mode==="byDimension"&&!k.color.byDimDef){g(0)}}}}if(i){h.setProperties(k)}};f.prototype.applySoftPatch=function(){if(!this.layout.usingSoftPatch){return}if(!this.appliedPatch){this.appliedPatch=true;this.extension.backendApi.applyPatches([{qPath:"/qHyperCubeDef/qDimensions/0/qDef/qFieldDefs",qOp:"replace",qValue:'["=Disabled"]'}],true)}};f.prototype.clearSoftPatch=function(){if(!this.layout.usingSoftPatch){return}if(this.appliedPatch){this.softPatchCleared=true;c(function(){this.softPatchCleared=false}.bind(this),1000);this.appliedPatch=false;this.extension.backendApi.clearSoftPatches()}};f.prototype.getColorObject=function(m,l){var k=this.layout.qHyperCube.qDimensionInfo[0];var j;if(this.layout.color.auto){j=l}else{if(this.layout.color.mode==="byDimension"&&k.qAttrDimInfo.length>0){j=d.getValue(l,"qAttrDims.qValues.0");if(!j){throw new Error("Invalid color dimension '"+k.qAttrDimInfo[0].label+"'")}if(j.qElemNo<0){this.addWarning("colorDim","Invalid color dimension, was not evaluated",l,j.qText)}}else{if(this.layout.color.mode==="byMeasure"&&k.qAttrExprInfo.length>0){j=l.qAttrExps.qValues[0]}else{j=l}}}var h;if(j.qText){h=j.qText}else{h=Number(j.qNum)||0}var i=d.getValue(k,"qAttrExprInfo.0.qMin",0);var g=d.getValue(k,"qAttrExprInfo.0.qMax",0);return a.getColorAndIndex(this.layout,m,h,i,g)};f.prototype.getSizeValue=function(h,g){var i;if(h[this.sizeSource_]){i=h[this.sizeSource_].qNum}if(isNaN(i)){this.addWarning("size","Invalid size value, not a number",h[0],i);i=g[this.sizeSource_-1].qMin}return i};f.prototype.isLocationDataValid=function(l,i,h){function g(r,o,q){for(var n=0;n<o;n++){var p=r[q+n];if(!p||!p.qNum||isNaN(p.qNum)||!p.qText||p.qText==="-"){return false}}return true}function j(r,o,q){for(var n=0;n<o;n++){var p=r[q+n];if(!p||!p.qText||p.qText==="-"){return false}}return true}if(this.isLocationIds&&!j(l,i,this.locationIdSource_,h)){var k=(l[this.locationIdSource_])?l[this.locationIdSource_].qText:"";this.addWarning("locationdata","Invalid Location ID, null or empty",l[0],k);return false}else{if(!this.isLocationIds&&!g(l,i,this.coordinateSource_)){var m=(l[this.coordinateSource_]&&l[this.coordinateSource_+1])?l[this.coordinateSource_].qText+","+l[this.coordinateSource_+1].qText:"";this.addWarning("locationdata","Invalid coordinate, null or not a number",l[0],m);return false}}return true};return f});