define(["./Utils"],function(Utils){(function(idevio){(function(qv){qv.showMore=function(event,goToTab){var $elem=$(event.srcElement);var $mainProperties=$elem.parents(".ToolWindow-MainBody");var $button=$elem.parents("div[role*=tabpanel]").find(".prop-more-less-button");var isOpen=$button.attr("data-state")==="on";function saveOldContent($tabs){var $oldSelectedTab=$tabs.find(".ui-tabs-active");$oldSelectedTab.removeClass("ui-tabs-active ui-state-active");if($oldSelectedTab.text()){var $oldContent=$tabs.parents(".idevioMore").find(".idevioContent>div").children();$mainProperties.find("h3.idevioMoreTab + div:empty").append($oldContent);$tabs.parents(".idevioMore").find(".idevioContent").remove()}}function showContent($tab,$targetContent){saveOldContent($tab.parent());$tab.addClass("ui-tabs-active ui-state-active");var $contentWrapper=$("<div>");$contentWrapper.addClass("tab-container foldout-shadow idevioContent");$contentWrapper.appendTo($tab.parents(".idevioMore"));var $content=$("<div>");$content.addClass("prop-grid_tab-padding-reset ui-tabs-panel ui-widget-content ui-corner-bottom");$content.append($targetContent.children());$content.appendTo($contentWrapper);$targetContent.empty()}if(goToTab){if(isOpen){var $tab=$mainProperties.parent().find(".idevioMore li[name="+goToTab+"]");var $src=$mainProperties.find("h3.idevioMoreTab > a:contains("+goToTab+")").parent().next();showContent($tab,$src)}return}$button.attr("data-state",!isOpen?"on":"off");$button.text(!isOpen?"Less...":"More...");if(!isOpen){var $moreWindow=$("<div>");$moreWindow.addClass("idevioMore tabs ui-tabs ui-widget ui-widget-content ui-corner-all");var $tabs=$("<ul>");$tabs.addClass("ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all");$mainProperties.find("h3.idevioMoreTab > a").each(function(idx,titleElem){var $title=$(titleElem);if($title.parent().attr("onmoreload")){eval($title.parent().attr("onmoreload"))}var $tab=$("<li>");var name=$title.text().trim();var $div=$title.parent().next();$tab.attr("name",name);$tab.addClass("tab tab-shadow ui-state-default ui-corner-top");if((idx===0&&!goToTab)||(name===goToTab)){setTimeout(function(){showContent(this,$div)}.bind($tab),0)}$tab.append($("<a>").text(name).attr("href","javascript:void(0)").click(function(){showContent($tab,$div)}));$tabs.append($tab)});$moreWindow.append($tabs);$mainProperties.before($moreWindow)}else{if(!goToTab){var $moreProperties=$mainProperties.parent().find(".idevioMore");saveOldContent($moreProperties.find("ul:first-child"));$moreProperties.remove()}}}})(idevio.qv||(idevio.qv={}))})(window.idevio||(window.idevio={}));var splashes={};return{deferredLoadEvents:{},getProperty:function(extension,propNr,defaultVal,setProperty){setProperty=setProperty||false;var key="Text"+propNr;if(!extension.Layout[key]||extension.Layout[key].text===""){if(setProperty&&extension.Layout[key]){extension.Layout[key].text=defaultVal}return defaultVal}return extension.Layout[key].text},getStoredObject:function(extension,propNr,defaults){var value=this.getProperty(extension,propNr,null);if(value){try{return JSON.parse(value)}catch(err){}}return defaults},addSplash:function(element,title,id,layertype){if(splashes[id]){splashes[id][0].css("display","block");splashes[id][1].css("display","block");return}var text;switch(layertype){case"idevioarealayer":text="This is an <b>"+title+".</b> Please right click this window, select properties and add a <b>dimension</b> and a <b>measure</b> in order to initiate it.";break;case"ideviogeodatalayer":text="This is a <b>"+title+".</b> Please right click this window, select properties and add a <b>Source URL</b> or a <b>Tile Service URL</b> in order to initiate it.";break;case"ideviochartlayer":text="This is a <b>"+title+".</b> Please right click this window, select properties and add two <b>dimensions</b> and at least one <b>measure</b> in order to initiate it.";break;default:text="This is a <b>"+title+".</b> Please right click this window, select properties and add a <b>dimension</b> and a <b>measure</b> in order to initiate it.";break}var $splash=$("<div>").attr("id","splash-"+id).addClass("splash");var $splashText=$("<p>").attr("id","splashtext-"+id).addClass("splashtext").html(text);$(element).append($splash).append($splashText);splashes[id]=[$splash,$splashText]},removeSplash:function(id){if(!splashes[id]){return}splashes[id][0].css("display","none");splashes[id][1].css("display","none")},setLegendVisible:function(id,visible){$("#legend-info-"+id).toggle(visible)},fixPropertiesValues:function(layout){this.fixDropdownValues(layout);this.fixCheckboxValues(layout);$(".helplink").html('<a href="http://bi.idevio.com/products/idevio-maps-5-for-qlikview" target="_blank">Qlik GeoAnalytics Help '+Utils.getVersion()+"</a>");this.fixInputValues(layout);this.runLoadEvents(layout)},runLoadEvents:function(){var $elem;$("[data-load]").each(function(idx,elem){$elem=$(elem);eventHandler({type:"load",target:elem,noPropsLoaded:true},$elem.data("load"));$elem.removeAttr("data-load")})},fixDropdownValues:function(layout){var id=layout.ObjectId.replace("\\","").replace("Server","").replace("Document","");try{var $elements=$("[id*="+id+"] [avq^='mySelect:.Chart.Text']");if($elements){for(var i=0;i<$elements.length;i++){var propNr=parseInt($elements[i].getAttribute("avq").replace("mySelect:.Chart.Text.",""));if(layout["Text"+propNr]){$elements[i].value=layout["Text"+propNr].text}}}}catch(e){console.error("Error in fixDropdownValues",e)}},fixCheckboxValues:function(layout){var id=layout.ObjectId.replace("\\","").replace("Server","").replace("Document","");try{var $elements=$("[id*="+id+"] [avq^='prop_checkbox:.Chart.Text']");if($elements){for(var i=0;i<$elements.length;i++){var propNr=parseInt($elements[i].getAttribute("avq").replace(/^[^:]+:.Chart.Text./,""));if(layout["Text"+propNr]){$elements[i].children[0].children[0].checked=layout["Text"+propNr].text}}}$("[id*="+id+"] [avq^='myCheckbox:.Chart.Text']").each(function(idx,elem){var $elem=$(elem);var propNr=parseInt($elem.attr("avq").replace(/^[^:]+:.Chart.Text./,""));if(layout["Text"+propNr]){$elem.prop("checked",!!layout["Text"+propNr].text)}})}catch(e){console.error("Error in fixCheckboxValues",e)}},fixExpressionValues:function(layout){var id=layout.ObjectId.replace("\\","").replace("Server","").replace("Document","");try{var $elements=$("[id*="+id+"] [avq^='prop_editexpression:.Chart.Text']");if($elements){for(var i=0;i<$elements.length;i++){var propNr=parseInt($elements[i].getAttribute("avq").replace(/^[^:]+:.Chart.Text./,""));if(layout["Text"+propNr]){$elements[i].children[0].children[0].value=layout["Text"+propNr].text}}}}catch(e){console.error("Error in fixExpressionValues",e)}},fixInputValues:function(layout){var id=layout.ObjectId.replace("\\","").replace("Server","").replace("Document","");try{var $elements=$("[id*="+id+"] [avq^='prop_editinput:.Chart.Text']");if($elements){for(var i=0;i<$elements.length;i++){var propNr=parseInt($elements[i].getAttribute("avq").replace(/^[^:]+:.Chart.Text./,""));if(layout["Text"+propNr]){$elements[i].children[0].value=layout["Text"+propNr].text}}}$("[id*="+id+"] [avq^='myEditinput:.Chart.Text']").each(function(idx,elem){var $elem=$(elem);var propNr=parseInt($elem.attr("avq").replace(/^[^:]+:.Chart.Text./,""));if(layout["Text"+propNr]){$elem.find("input").val(layout["Text"+propNr].text)}})}catch(e){console.error("Error in fixInputValues",e)}},getMeasureInfo:function(dataRows,headerRows,numDimensions){if(dataRows.length===0||headerRows.length===0){return[]}numDimensions=numDimensions||1;var measureInfo=new Array(headerRows[0].length-numDimensions);for(var j=numDimensions;j<dataRows[0].length;j++){var maxValue=Number.MIN_VALUE;var minValue=Number.MAX_VALUE;var allNan=true;var curValue;for(var i=0;i<dataRows.length;i++){var value=dataRows[i][j];if(value.data!==""){curValue=parseFloat(value.data.replace(",","."))}else{curValue=parseFloat(value.text.replace(",","."))}if(!isNaN(curValue)){allNan=false;if(curValue>maxValue){maxValue=curValue}if(curValue<minValue){minValue=curValue}}}measureInfo[j-numDimensions]={qMax:(allNan)?NaN:maxValue,qMin:(allNan)?NaN:minValue,qFallbackTitle:headerRows[0][j].text}}return measureInfo},loadCss:function(extension){var cssFiles=[];cssFiles.push("Extensions/"+extension+"/style.css");if(!this.commonCss){cssFiles.push("Extensions/IdevioMap/common.css");this.commonCss=true}for(var i=0;i<cssFiles.length;i++){Qva.LoadCSS(Qva.Remote+(Qva.Remote.indexOf("?")>=0?"&":"?")+"public=only&name="+cssFiles[i])}},getLabelText:function(measures,properties,labelIndex){if(measures[labelIndex]&&properties.label.visible){return measures[labelIndex].text}else{return""}},isRestrictedDrillDown:function(properties,headerRows){if(!headerRows||headerRows.length===0||headerRows[0].length===0){return 0}var drilldown=headerRows[0][0];if((properties.restrictDrillDownLevel!=="")&&("group" in drilldown)){var layer=Utils.layers[properties.qInfo.qId];var groupPos;var i;for(i=0;i<headerRows[0][0].members.length;i++){if(headerRows[0][0].members[i].active){groupPos=i}}var enteredLevels=String(properties.restrictDrillDownLevel).split(",").map(Number);if(enteredLevels.indexOf(groupPos)===-1){if(layer){layer.isRestricted=true}return 1}else{if(layer){layer.isRestricted=false}return 0}}return 0},formatMeasureDataLikeSense:function(measures){for(var i=0;i<measures.length;i++){if(measures[i].text!=="-"){measures[i].qNum=parseFloat(measures[i].data);measures[i].qText=measures[i].text}else{measures[i].qNum="NaN";measures[i].qText="-"}}return measures}}});