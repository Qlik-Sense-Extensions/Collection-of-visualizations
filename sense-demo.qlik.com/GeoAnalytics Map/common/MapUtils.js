define(["./Utils"],function(b){var a={selectFeatures:function(e,d){var c=false;if($("#selection-toolbar").length===0){a.activateSelectionToolbar(d)}if(e[0]&&e[0]==="click"){e=e.slice(1);c=true;if(!e||e.length===0){if(!d.selectedData||d.selectedData.length===0){a.disableButtons(true)}return}}else{if(e[0]==="geometry-select"){e=e.slice(1);a.cancelSelection(d);d.select(e)}}a.disableButtons(true);if(!b.getDimensions()){return}var g=[];if(d.selectedDimension&&g.indexOf(d.selectedDimension)===-1){g.push(d.selectedDimension)}var h=e.filter(function(m){var o=m.getAttribute("elemNumber");if((!b.qlikview&&o>=0)||(b.qlikview&&(o!=="-")||(o!==""))){var k=m.getDataset().getName();if(d.selectedDimension&&d.selectedDimension!==k){return false}if(g.indexOf(k)===-1){g.push(k)}if(c&&d.selectedData){var n=-1;for(var l=0;l<d.selectedData.length;l++){var j=d.selectedData[l].getDataset().getName();if(j===k&&d.selectedData[l].getAttribute("elemNumber")===o){n=l;break}}if(n===-1){return true}else{d.selectedData.splice(n,1);return false}}else{if(!d.selectedData){d.selectedData=[]}return true}}});if(d.selectedData){if(h){d.selectedData=d.selectedData.concat(h)}if(d.selectedData.length===0){g=[];delete d.selectedDimension}}if(g.length&&Object.keys(b.getDimensions()).length>1){a.addToolbarDropDown(d,g)}else{if(Object.keys(b.getDimensions()).length===1){a.removeToolbarDropDown();d.selectedDimension=d.selectedDimension||Object.keys(b.getDimensions())[0]}else{a.removeToolbarDropDown()}}if(c){d.selectedDimension=d.selectedDimension||$("#selection-toolbar-dropdown").val()}if(d.selectedData){var f=[];d.selectedData.forEach(function(j){var k=d.selectedDimension||$("#selection-toolbar-dropdown").val();var i=j.getDataset().getName();if(i===k&&f.indexOf(j)===-1){f.push(j)}});if(f.length>0){a.disableButtons(false);d.map.setHighlighted(f)}else{delete d.selectedDimension;d.selectedData=[];d.map.setHighlighted([])}}},confirmSelection:function(l){if(typeof(l.selectedData)==="undefined"||!l.selectedData.length){return}var n=l.selectedDimension||$("#selection-toolbar-dropdown").val();var e=b.layers[n];if(!e){return}var k=[];var g={};var c=b.getSelectableLayers();for(var m in c){if(!c.hasOwnProperty(m)){continue}var d=c[m].layer.getDataset().getAll();g[m]=g[m]||{};for(var h=0;h<d.length;h++){var j=d[h].getAttribute("elemNumber");g[m][j]=true}}l.selectedData.forEach(function(i){if(i.getDataset().getName()===n){k.push(i.getAttribute("elemNumber"))}});var f=k.sort().filter(function(i,o){return(!o||i!==k[o-1])&&g[n][i]});if(f.length>0){if(b.qlikview){e.extension.Data.SelectTextsInColumn(0,false,f)}else{e.extension.backendApi.selectValues(0,f,false)}}a.cancelSelection(l)},cancelSelection:function(c){delete c.selectedDimension;c.selectedData=[];c.map.setHighlighted([]);a.removeSelectionToolbar(c);a.removeDrawingCanvas(c);if(b.qlikview&&c.map.bubbleTool){c.map.bubbleTool.hide()}},clearSelection:function(c){if(c.selectedData&&c.selectedData!==[]){delete c.selectedData;delete c.selectedDimension;c.map.setHighlighted([]);a.disableButtons(true);a.removeToolbarDropDown()}},removeSelectionToolbar:function(d){if(!b.qlikview){var f=$(d.map.getDiv());var c=f.parents(".qv-object-ideviomap");var e=c.children(".qv-object-nav");c.removeClass("active-selection");e.show()}$("#selection-toolbar").remove()},toggleLasso:function(d,e){var c=$(d.map.getDiv()).find(".selection-toolbar-lasso");if(typeof e!=="undefined"){if(e){c.addClass("selection-toolbar-lasso-active");d.toggleLasso=true}else{c.removeClass("selection-toolbar-lasso-active");d.toggleLasso=false}}else{c.toggleClass("selection-toolbar-lasso-active");d.toggleLasso=(d.toggleLasso)?false:true}if(d.toggleLasso){a.addDrawingCanvas(d)}else{a.removeDrawingCanvas(d)}},disableButtons:function(c){document.getElementById("clear-button").disabled=c;document.getElementById("confirm-button").disabled=c},addToolbarDropDown:function(m,e){var d=$("#selection-toolbar");var f;var c;if($("#selection-toolbar-dropdown").length===0){f=$("<select>",{id:"selection-toolbar-dropdown","class":"selection-toolbar-dropdown"});f.change(function(){var i=m.selectedData.filter(function(o){return f.val()===o.getDataset().getName()});m.map.setHighlighted(i)})}else{f=$("#selection-toolbar-dropdown").detach();f.empty()}var n=b.getDimensions();var g=[];for(c in n){if(b.layers[c].layer){g.push([c,n[c],b.layers[c].layer.getDrawOrder()])}}g.sort(function(o,i){return i[2]-o[2]});var k={};for(var j=0;j<g.length;j++){k[g[j][0]]=g[j][1]}for(c in k){if(e.indexOf(c)!==-1){var l=b.layers[c].layerTitle;var h=b.qlikview?k[c]:k[c]();$("<option>",{value:c,text:h+" - "+l}).appendTo(f)}}d.append(f);if($("#selection-toolbar-dropdown-title").length===0){$("<span>",{id:"selection-toolbar-dropdown-title","class":"selection-toolbar-dropdown-title"}).css("right",f.width()+230).html("Selection dimension").appendTo(d)}if(m.selectedDimension){$("#selection-toolbar-dropdown").find("select").val(m.selectedDimension)}d.append(f)},removeToolbarDropDown:function(){$("#selection-toolbar-dropdown").remove();$("#selection-toolbar-dropdown-title").remove()},activateSelectionToolbar:function(j){j.toggleLassoFunc=a.toggleLasso;var h=$(j.map.getDiv());var d;var i;if(b.qlikview){i=0;d=$("<div>",{id:"selection-toolbar","class":"selection-toolbar"})}else{var l=h.parents(".qv-object-ideviomap");var e=l.children(".qv-object-nav");l.addClass("active-selection");e.hide();i=parseInt($(".qv-object-title").css("padding-bottom"),10)||0;d=$("<div>",{id:"selection-toolbar","class":"selection-toolbar"}).css("top",-44)}var k=$("<button>",{id:"confirm-button"}).addClass("selection-toolbar-button selection-toolbar-confirm").click(function(){a.confirmSelection(j)});var f=$("<button>",{id:"cancel-button"}).addClass("selection-toolbar-button selection-toolbar-cancel").click(function(){a.cancelSelection(j)});var g=$("<button>",{id:"lasso-button"}).addClass("selection-toolbar-button selection-toolbar-lasso").click(function(){a.toggleLasso(j)});var c=$("<button>",{id:"clear-button"}).addClass("selection-toolbar-button selection-toolbar-clear").click(function(){a.clearSelection(j)});$("<span>").addClass("selection-toolbar-span-icon selection-toolbar-icon-confirm").appendTo(k);$("<span>").addClass("selection-toolbar-span-icon selection-toolbar-icon-cancel").appendTo(f);$("<span>").addClass("selection-toolbar-span-icon selection-toolbar-icon-lasso").appendTo(g);$("<span>").addClass("selection-toolbar-span-icon selection-toolbar-icon-clear").appendTo(c);$("body").off("click").on("click",function(n){var o=n.target.id;var m=n.target.className;if(m!=="idevio-bubble"&&m!=="idevio-map-canvas"&&!$(n.target).parents(".idevio-bubble").length){b.resetAllInfoBubbleTools()}if(m==="icon-toolbar-clearselections"||m==="icon-toolbar-navigation-forward"||m==="icon-toolbar-navigation-back"||m==="qv-subtoolbar-button borderbox"){a.cancelSelection(j);return}if(m!=="errorList"&&m.indexOf("errorButton")===-1&&$(n.target).parents(".errorList").length<1){h.find("div.errorList").hide()}if(!(m==="idevio-map-canvas"||m==="idevio-bubble"||m==="idevio_select_overlapping"||o==="selection-toolbar"||o==="map-info-bubble"||$(n.target).closest("#selection-toolbar").length||$(n.target).parents(".idevio-bubble").length)){if(j.selectedData&&j.selectedData.length!==0){a.confirmSelection(j)}else{a.cancelSelection(j)}}});d.append(k,f,g,c);if(b.qlikview){h.append(d)}else{l.append(d)}},addDrawingCanvas:function(e){$("#drawCanvas").remove();var c=e.tools.boxSelectTool;var h=e.map.getDiv();var f=document.createElement("canvas");f.id="drawCanvas";f.width=h.clientWidth;f.height=h.clientHeight;f.style.zIndex="10000";f.style.position="absolute";f.style.border="0px";f.style.top="0px";f.style.left="0px";function g(i){c._release(i,{x:$(f).offset().left,y:$(f).offset().top});a.toggleLasso(e,false)}function d(j){if(!c._startEvent){c._startEvent=j;f._startEvent=j}else{c._distance=c._distanceBetweenPoints(c._startEvent.pageX,c._startEvent.pageY,j.pageX,j.pageY);var i=c._distance<=10;if(f._endEvent||!i){f._endEvent=j;j.target.getContext("2d").clearRect(0,0,$(f).width(),$(f).height());c._draw(j,f)}}}f.addEventListener("touchstart",function(i){c._start(i)});f.addEventListener("touchmove",function(i){d(i)});f.addEventListener("touchend",function(i){g(i)});f.addEventListener("touchout",function(i){g(i)});f.addEventListener("mousedown",function(i){c._start(i);f.buttonPressed=true});f.addEventListener("mousemove",function(i){if(f.buttonPressed||f.ignoreButton){d(i)}});f.addEventListener("mouseup",function(i){f.buttonPressed=false;g(i)});f.addEventListener("mouseout",function(i){f.buttonPressed=false;g(i)});$(h).append(f);return f},removeDrawingCanvas:function(){$("#drawCanvas").remove()},createGridSelectionButton:function(c){return $('<button style="z-index: 2; position: absolute; bottom: 18px; right: 8px"></button>').click(function(){c.selectVisibleButtonToggled=!c.selectVisibleButtonToggled;if(c.properties!=null||c.properties.selectVisibleGrid!=null){c.properties.selectVisibleGrid=c.selectVisibleButtonToggled}a.updateGridSelectionButtonText(c,c.selectVisibleButtonToggled)}.bind(this))},updateGridSelectionButtonText:function(d,c){var e=(c)?"On":"Off";d.$gridSelectionButton.text("Select Visible: "+e)},isValidSpatialIndexList:function(c){return/^(IdevioSIndexH\d+((.|_)\d+)?W\d+((.|_)\d+)?)(\s*,\s*IdevioSIndexH\d+((.|_)\d+)?W\d+((.|_)\d+)?)*,*$/.test(c)},parseSpatialIndexList:function(d){if(!a.isValidSpatialIndexList(d)){return null}var c={};d.split(/\s*,\s*/).forEach(function(e){if(e!==""){c[e]=e.substring(13).replace("_",".").replace("_",".").split("W").map(Number)}});return c},getVisibleGridIndices:function(h,k){var f=Infinity;var i=[];var j;for(var c in h){if(h.hasOwnProperty(c)){var g=h[c];var m=(k.max[0]-k.min[0])/g[0]*(k.max[1]-k.min[1])/g[1];var d=Math.abs(25-m);if(d<f){j=c;f=d}}}if(b.qlikview&&f>1000){return{id:j,indices:[]}}if(!(k.min[1]<=-180&&k.max[1]>=180)){if(k.min[1]<-180){var e={min:[k.min[0],k.min[1]+360],max:[k.max[0],180]};a.generateVisibleGridIndices(h,e,j,i)}else{if(k.max[1]>180){var l={min:[k.min[0],-180],max:[k.max[0],k.max[1]-360]};a.generateVisibleGridIndices(h,l,j,i)}}}a.generateVisibleGridIndices(h,k,j,i);return{id:j,indices:i}},generateVisibleGridIndices:function(g,o,m,i){var e=g[m][1];var j=g[m][0];var c=Math.floor(o.min[1]/e);var f=Math.floor(o.max[1]/e);var n=Math.floor(o.min[0]/j);var d=Math.floor(o.max[0]/j);for(var k=n;k<=d;k++){for(var l=c;l<=f;l++){var h=l+"|"+k;i.push(h)}}},wrapLongitude:function(e,c){var d=2*c;e%=d;if(e>c){e-=d}else{if(e<-c){e+=d}}return e},wrapBounds:function(e,d){if(!e||!d){return}if(e.max[1]-e.min[1]>2*d){e.min[1]=-d;e.max[1]=d;return}var c=a.wrapLongitude(e.min[1],d);if(c!==e.min[1]){e.max[1]-=e.min[1]-c;e.min[1]=c}},mergeBounds:function(i,f,h){if(!i&&!f){return null}var g;if(h.getWrapLongitude){g=h.getWrapLongitude()}else{if(h.getBaseMap()!=="emptymeters"){g=180}}if(g){a.wrapBounds(f,g);a.wrapBounds(i,g)}var c;if(!i){c=f}else{if(!f){c=i}else{c={min:[Math.min(i.min[0],f.min[0]),Math.min(i.min[1],f.min[1])],max:[Math.max(i.max[0],f.max[0]),Math.max(i.max[1],f.max[1])]}}}if(g){var d=g*2*0.9;var e=c.max[1]-c.min[1];if(e>d){var j=(e-d)/2;c.min[1]+=j;c.max[1]-=j}}return c},addArcGISLayer:function(d,e,h,c,l){var g=d.getBaseMap()==="emptymeters";var k=d.getBaseMap()==="empty";var j=new idevio.map.TiledImageLayer(d,{name:e,drawOrder:c,visible:false,dataset:new idevio.map.TiledImageDataset({url:"http://services.arcgisonline.com/arcgis/rest/services/"+h+"/MapServer/tile/{z}/{y}/{x}",crs:!g&&!k?"EPSG:3857":"undefined",originX:-20037508,originY:20037508,tileWidth:40075016,tileHeight:40075016,urlFunction:function(p,n,m,q){m=-(m+1);var o=Math.pow(2,q);if(n<0||m<0||n>=o||m>=o){return null}return p.replace("{z}",q).replace("{x}",n).replace("{y}",m)}})});if(l&&!Array.isArray(l)){l=[l]}if(!l||l.length===0){return}var i=$(".idevio-map-canvas",d.getDiv());if(!i.length){console.error("Could not find map canvas.");return}var f=i[0].getContext("2d");j.defSetVisible=j.setVisible;j.setVisible=function(m){this.defSetVisible(m);if(m){this.attrListenerId=d.addListener("draw",function(){var p,n,q;f.save();f.textBaseline="bottom";f.lineWidth=1.5;f.textAlign="right";f.fillColor="white";f.strokeColor="black";f.font="10px sans-serif";for(var o=0;o<l.length;o++){p=l[l.length-1-o];n=i.width()-3;q=i.height()-(13+o*10);f.strokeText(p,n,q);f.fillText(p,n,q)}f.restore()})}else{d.removeListener(this.attrListenerId)}};j.defRemove=j.remove;j.remove=function(){d.removeListener(this.attrListenerId);this.defRemove()}}};return a});