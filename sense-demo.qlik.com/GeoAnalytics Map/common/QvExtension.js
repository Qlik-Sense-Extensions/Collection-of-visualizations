define(["./Extension","./LegendManager","./ColorManager","./Utils","./QvUtils"],function(f,e,b,d,a){function c(j,m,k,i){i=i||{};var g=i.numDimensions||1;k=this.initLayout(k,m,g);f.call(this,j,m,k,$(m.Layout.Super.Element),i);this.element.on("remove",this.destroy.bind(this));this.numDimensions=g;if(i.cssClass){this.element.addClass(i.cssClass)}if(i.cssFile){a.loadCss(i.cssFile)}if(document.documentMode&&document.documentMode<11){var l=m.Element.parentNode;l.addEventListener("DOMAttrModified",function(n){if(n.attrName==="style"&&n.newValue.indexOf("display: none")>-1){this.clearLayer(true)}}.bind(this))}else{var h=new MutationObserver(function(n){n.forEach(function(o){var p=o.target.attributes.style.nodeValue;if(p.indexOf("display: none")>-1){this.clearLayer(true)}}.bind(this))}.bind(this));h.observe(m.Element.parentNode,{attributes:true,attributeFilter:["style"]})}a.setLegendVisible(this.id,false);a.addSplash(this.element,this.layout.title,this.id,this.layout.qInfo.qType)}f.extend(c);c.prototype.waitForMapExtension=function(){if(this.initialized){return}var g=d.getValue(this,"layout.mapid");d.clearErrorInLegend(this);var i=Object.keys(d.maps);if(i.length===0){this.toggleSplash(false);d.setErrorInLegend(this,"No GeoAnalytics Map added to sheet. Please add an GeoAnalytics Map.",false);return}if(!g||g===d.NO_MAP_ID){this.toggleSplash(false);d.setErrorInLegend(this,"No map id set. Please select a new map in Layer Options.",false);return}var h=d.maps[g];if(h){this.init(h)}else{setTimeout(function(){h=d.maps[d.getValue(this,"layout.mapid")];if(h){this.init(h)}else{this.toggleSplash(false);d.setErrorInLegend(this,"Could not find a map with the ID specified in Layer Options",false)}}.bind(this),1000)}};c.prototype.initLayout=function(j,l,g){var k=l.Layout;a.fixPropertiesValues(k);j.qInfo.qId=k.ObjectId.replace("\\","");j.title=k.Caption.label;j.qHyperCube={qMeasureInfo:a.getMeasureInfo(l.Data.Rows,l.Data.HeaderRows,g),qDimensionInfo:[],qDataPages:l.Data.Rows};for(var h=0;h<g;h++){j.qHyperCube.qDimensionInfo.push({qFallbackTitle:d.getValue(l,"Data.HeaderRows.0."+h+".text","")})}return j};c.prototype.on=d.NOP;c.prototype.off=d.NOP;c.prototype.applySoftPatch=d.NOP;c.prototype.clearSoftPatch=d.NOP;c.prototype.fixColorSettings=d.NOP;c.prototype.init=function(j){f.prototype.init.call(this,j);var k=this.layout.qInfo.qId;if(a.deferredLoadEvents[k]){for(var h=0;h<a.deferredLoadEvents[k].length;h++){try{a.deferredLoadEvents[k][h]()}catch(g){this.addError("propertyWindowError","Error updating property window: "+(g.message?g.message:g))}}a.deferredLoadEvents[k]=null}};c.prototype.paintExtension=function(g){this.layout=this.initLayout(g,this.extension,this.numDimensions);this.headerRows=this.extension.Data.HeaderRows;this.totalData=this.extension.Data.TotalSize.y||0;this.dimension=d.getValue(g,"qHyperCube.qDimensionInfo.0.qFallbackTitle","");var h=!this.isVisible()?1:this.layout.maxObjects;if(this.extension.Data.PageSize.y!==h){this.extension.Data.SetPagesizeY(h);return}f.prototype.paintExtension.call(this,g)};c.prototype.prepare=function(){f.prototype.prepare.call(this);var h=d.getValue(this,"layout.qHyperCube.qMeasureInfo",[]);this.hasColorMeasure=this.colorSource_!==-1&&h.length>=this.colorSource_;if(d.getValue(this,"layout.color.auto")){this.isSingleColor=!this.hasColorMeasure;this.isColorExpression=false;this.isColorFromMeasure=b.isByMeasure(this.layout)&&this.hasColorMeasure;this.isSchemeGradient=true;this.isByDimension=false}else{this.isSingleColor=b.isSchemeSingleColor(this.layout)||d.getValue(this,"layout.color.auto")&&!this.hasColorMeasure;this.isColorExpression=b.isByExpression(this.layout);this.isColorFromMeasure=b.isByMeasure(this.layout)&&this.hasColorMeasure;this.isSchemeGradient=b.isSchemeGradient(this.layout);this.isByDimension=b.isByDimension(this.layout)}if(typeof testLayer!=="undefined"){d.addPropertiesForTestLayer(this.layout,this.extension)}if(d.getValue(this.layout,"color.auto")){this.layout.color={auto:true,mode:this.colorSource_!==-1?"byMeasure":"primary",singleColor:b.DEFAULT_PRIMARY_COLOR,measureScheme:"sg",dimensionScheme:"12",alpha:d.getValue(this.layout,"color.alpha",1),expressionIsColor:true}}var i=typeof this.coordinateSource_==="undefined"||this.coordinateSource_===-1;var g=typeof this.locationIdSource_==="undefined"||this.locationIdSource_===-1;if(!this.isStatic&&i&&g){this.toggleSplash(true);this.clearLayer(false);this.isInitialized=false;return true}else{this.isInitialized=true;this.toggleSplash(false);if(!this.legendInit||this.element.find(".legend-info").length===0){e.initLegend(this)}return false}};c.prototype.toggleSplash=function(g){if(g){d.clearErrorInLegend(this);a.setLegendVisible(this.id,false);a.addSplash(this.element,this.layout.title,this.id,this.layout.qInfo.qType)}else{a.removeSplash(this.id);a.setLegendVisible(this.id,true)}};c.prototype.initPaint=function(){this.paint(this.extension.Data.Rows)};c.prototype.setVisible=function(h){this.visible=h;if(this.layer){this.layer.setVisible(h)}if(h===true&&qva.IsRemote===true&&(this.id.lastIndexOf("Document",0)===0)){this.extension.Paint()}var g=this.extension.propertyMapping.visible;this.extension.Layout.SetProperty(g,(h===true)?1:0,true)};c.prototype.isRestrictedDrilldown=function(){if(this.headerRows){if(this.headerRows.length){return a.isRestrictedDrillDown(this.layout,this.headerRows)}else{return false}}return a.isRestrictedDrillDown(this.layout,this.headerRows)};c.prototype.getColorObject=function(m,l,h){var k=h[this.colorSource_-1];var i=l.qText;if(this.isColorFromMeasure||(this.layout.color.auto&&this.hasColorMeasure)){if(m[this.colorSource_].qIsNull){this.addWarning("colorNull","Color value is null",l);i=(k?k.qMin||0:0)}else{if(m[this.colorSource_]&&!isNaN(m[this.colorSource_].qNum)){i=m[this.colorSource_].qNum}else{i=m[this.colorSource_].qText;this.addWarning("colorNaN","Color value is not a number",l,i);i=(k?k.qMin||0:0)}}}var j=k?k.qMin:0;var g=k?k.qMax:0;return b.getColorAndIndex(this.layout,m,i,j,g)};return c});