define(["../IdevioMap/common/Utils","../IdevioMap/common/ColorManager","../IdevioMap/common/LegendManager","../IdevioMap/common/LocationManager","../IdevioMap/common/SizeManager","../IdevioMap/common/MathUtils","../IdevioMap/common/Extension"],function(e,b,f,d,a,c,h){function g(k,j,i){h.call(this,"Line Layer",k,j,i)}h.extend(g);g.prototype.ensureBackCompat=function(j){var i=j||{};e.setIfUndefined(this.layout,"label.slider",i,e.getValueFromLogScaleRevert(e.getValue(this.layout,"label.outres",10000),0,10000,0.1,160000));e.setIfUndefined(this.layout,"restrictDrillDownLevelSlider",i,e.parseListToInterval(this.layout.restrictDrillDownLevel,0,16));e.setIfUndefined(this.layout,"size.range",i,[e.getValue(this.layout,"Width.min.value",1),e.getValue(this.layout,"Width.max.value",10)]);h.prototype.ensureBackCompat.call(this,i)};g.prototype.calcDataSourceIndex=function(){this.numCoordinates_=4;this.locationIdSource_=-1;this.coordinateSource_=-1;this.styleMeasureIndex_=-1;this.numMeasuresRequired_=-1;this.usingPolylines_=false;var i=this.layout.qHyperCube.qMeasureInfo;var j=e.getValue(this.layout,"location.source","auto");if(j==="auto"){if(i[0]&&!isNaN(i[0].qMax)&&!isNaN(i[0].qMin)){this.coordinateSource_=1;this.styleMeasureIndex_=5}else{if(i[0]&&isNaN(i[0].qMax)){this.locationIdSource_=1;this.styleMeasureIndex_=3}else{if(this.layout.qHyperCube.qDimensionInfo[0]){this.locationIdSource_=0;this.styleMeasureIndex_=1;this.numMeasuresRequired_=0;this.usingPolylines_=true}}}}else{if(j==="dimensionLocationId"){this.locationIdSource_=0;this.styleMeasureIndex_=1;this.numMeasuresRequired_=0;this.usingPolylines_=true}else{if(j==="coordinates"){this.coordinateSource_=1;this.styleMeasureIndex_=5}else{if(j==="measureStartEnd"){this.locationIdSource_=1;this.styleMeasureIndex_=3}else{if(j==="measureLocationId"){this.locationIdSource_=1;this.styleMeasureIndex_=2;this.numMeasuresRequired_=1;this.usingPolylines_=true}}}}}if(this.coordinateSource_===-1&&this.locationIdSource_!==-1){this.dsType="LocationIds"}if(this.coordinateSource_!==-1&&this.locationIdSource_===-1){this.dsType="Coordinates"}if(this.numMeasuresRequired_===-1){this.numMeasuresRequired_=(this.dsType==="LocationIds")?2:4}this.sizeSource_=(i[this.styleMeasureIndex_-1]&&this.styleMeasureIndex_!==-1)?this.styleMeasureIndex_:-1;this.colorSource_=this.styleMeasureIndex_===-1?-1:this.styleMeasureIndex_+1};g.prototype.prePaint=function(k){var l=this.map.map;var i=/service/i.test(e.getValue(this.layout,"location.serviceType"));var j=i?"id":e.getValue(this.layout,"location.keyAttribute","id");var n=[j,"elemNumber","label","color","size","infoBubbleHtml"];this.colorInfo_={};this.isGeometry=e.isQlikGeometry(k,this.locationIdSource_);if(this.isGeometry){this.dataset=new idevio.map.MemoryDataset({crs:l.getBaseMap()==="emptymeters"?"emptymeters":null,name:this.id});this.layer.setDataset(this.dataset)}else{if(this.usingPolylines_){this.dataset=d.createDataset(this.id,this.layout.location,this.map,n,function(){if(this.layer){this.setStyles(this.sizeHelper,this.colorTable);this.layer.setDataset(this.dataset)}this.dataLoaded=true;e.addInfoBubbleTool(this,l,this.layout,"hover_click")}.bind(this))}else{if(this.dsType==="LocationIds"){var m=function(){var u={};var v=this.dataset.getAll();if(v.length===0||typeof v[0].getCoordinate!=="function"){return}for(var s=0;s<v.length;s++){var o=v[s];u[o.getAttribute(j)]=o.getCoordinate()}this.dataset.removeAll();var q=this.atttable;if(!this.number){this.number=true}for(var r in q){if(!q.hasOwnProperty(r)){continue}var t=q[r];var x=u[t[0]];var w=u[t[1]];if(x&&w){new idevio.map.LineStringFeature(this.dataset,{coordinates:c.makeLineArc(x,w,this.layout.curviness,l.getBaseMap()!=="emptymeters"),attributes:t[2]})}}}.bind(this);this.dataset=d.createDataset(this.id,this.layout.location,this.map,n,function(){if(this.layer){this.setStyles(this.sizeHelper,this.colorTable);this.layer.setDataset(this.dataset)}m();e.addInfoBubbleTool(this,l,this.layout,"hover_click")}.bind(this))}else{this.dataset=new idevio.map.MemoryDataset({crs:l.getBaseMap()==="emptymeters"?"emptymeters":null,name:this.id});this.layer.setDataset(this.dataset)}}}};g.prototype.paint=function(E){var u=this.layout.qHyperCube.qMeasureInfo;if(u.length<this.numMeasuresRequired_){return}var y;if(this.isLocationIds){y=e.isGeoMakePoint(E,this.locationIdSource_)&&e.isGeoMakePoint(E,this.locationIdSource_+1)}this.colorTable=(this.isColorExpression||this.isSchemeGradient)?{}:b.getColorScheme(this.layout);this.sizeHelper=a.prepareHelper(this.layout.Width,u,this.sizeSource_);var A=[];this.atttable=[];for(var B=0;B<E.length;B++){var v=E[B].qMatrix;for(var o=0;o<v.length;o++){var t=v[o];var C=t[0];var x;var p;var m;var i;if(C.qIsEmpty||(C.qElemNumber<0)||C.qIsNull||!C.qText){continue}if(this.isGeometry&&!y){i=t[this.locationIdSource_].qText}else{if(this.usingPolylines_&&!y){p=d.getLocationIds(this.layout,t,this.locationIdSource_,this.remap,1)[0]}else{var q=this.isLocationIds?2:4;if(!this.isLocationDataValid(t,q)){continue}if(this.isLocationIds&&!y){var D=d.getLocationIds(this.layout,t,this.locationIdSource_,this.remap,2);p=D[0];m=D[1];A.push([p]);A.push([m])}else{if(this.isLocationIds&&y){x=d.getQlikPoints(t,this.locationIdSource_,2)}else{x=d.getCoordinates(t,this.coordinateSource_,2)}}}}var k=e.getInfoBubbleHtml(t,u,this.layout,this);var w=this.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle;var r={dimension:this.dimension,elemNumber:C.qElemNumber,id:C.qText,infoBubbleHtml:k,label:e.getLabelText(t,this.layout)};r[w]=C.qText;if(this.sizeSource_!==-1){this.sizeHelper.addValue(t,r)}if(!this.isSingleColor){var l=this.getColorObject(t,C);r.color=l.index;if(this.isByDimension&&this.layout.qHyperCube.qDimensionInfo[0].qAttrDimInfo.length>0){this.colorInfo_[String(C.qAttrDims.qValues[0].qText)]=l.color}else{this.colorInfo_[String(l.index)]=true}if(this.isColorExpression||this.isSchemeGradient){this.colorTable[r.color]=l.color}}if(this.isGeometry&&!y){try{var j=[];var s=JSON.parse(i);if(Array.isArray(s[0][0][0])||Array.isArray(s[0][0])){j=j.concat.apply(j,s).map(e.switchCoordinates)}else{j=s.map(e.switchCoordinates)}new idevio.map.LineStringFeature(this.dataset,{coordinates:j,attributes:r})}catch(z){this.addWarning("areaPolygonFeature","Error adding polygon feature",undefined,"["+i+"]")}}else{if(this.usingPolylines_&&!y){A.push([p,r.elemNumber,r.label,r.color,r.size,k])}else{if(this.isLocationIds&&!y){this.atttable.push([p,m,r])}else{try{new idevio.map.LineStringFeature(this.dataset,{coordinates:c.makeLineArc(x[0],x[1],this.layout.curviness,this.map.map.getBaseMap()!=="emptymeters"),attributes:r})}catch(z){this.addWarning("lineErrorFeature","Error adding feature",C)}}}}}}if(this.isLocationIds&&!y&&!this.isGeometry){this.dataset.setData(A)}else{this.setStyles(this.sizeHelper,this.colorTable)}if(this.isGeometry||this.dsType==="Coordinates"||y){var n=(this.layout.includeInAutoZoom!==false&&this.dataset.getAll().length>0)?this.dataset.getAlternateBounds():null;this.map.doneWorkViewBounds(this.id,n);e.addInfoBubbleTool(this,this.map.map,this.layout,"hover_click")}};g.prototype.setStyles=function(k,m){var j={type:"line",widthKey:k.sizes?"size":null,widths:k.sizes,width:k.defaultSize,color:b.getPrimaryColor(this.layout),colorKey:this.isSingleColor?null:"color",colors:this.isSingleColor?null:m};var i={type:"text",textAttribute:"label",font:"8pt sans-serif",placement:"fixed",anchorX:"middle",anchorY:"middle",haloColor:"lightgray"};if(this.layout.arrow&&this.layout.arrow.style!=="none"){var l={type:this.layout.arrow.style,position:this.layout.arrow.position/100};j.arrow=l}if(this.layout.label&&this.layout.label.outres){i.maxRes=this.layout.label.outres}this.layer.setStyles([j,i])};g.prototype.paintLegend=function(){var t=this.layout.qHyperCube.qMeasureInfo;var m=e.getValue(this.layout,"legend.sizes.auto",true);var p=e.getValue(this.layout,"legend.sizes.showSizes",true);var n=e.getValue(this.layout,"legend.sizes.showMinMax",true);var o=e.getValue(this.layout,"legend.sizes.showTitle",true);var w=m||p;var l=$("#legend-info-"+this.id).empty();var x=$("<div>").addClass("legend-data-info").appendTo(l);var k=this.isVisible();var v={};var i=this.styleMeasureIndex_-1;if(k&&this.sizeSource_!==-1){var q=t[this.sizeSource_-1].qMin;var u=t[this.sizeSource_-1].qMax;v={min:((!this.layout.Width.minValue.manual)?c.validateFloat(this.layout.Width.minValue.value,q):q),max:((!this.layout.Width.maxValue.manual)?c.validateFloat(this.layout.Width.maxValue.value,u):u),maxwidth:(c.validateInt(this.layout.Width.max.value,10)),minwidth:(c.validateInt(this.layout.Width.min.value,1)),title:t[i].qFallbackTitle}}i++;if(w){l.append($("<div>").addClass("legend-size").append(f.createLinesForLegend(v,l,this.layout,this.isSingleColor)))}else{x.css("left","-30px")}if(m||o){var z=e.getValue(this.layout,"qHyperCube.qDimensionInfo.0.qFallbackTitle");if(this.sizeSource_!==-1&&t[this.sizeSource_-1]){z=t[this.sizeSource_-1].qFallbackTitle}$("<span>").addClass("data-info-title").html(z).appendTo(x)}if(m||n){if(v.max>v.min&&v.maxwidth>v.minwidth){var j=c.formatNumberForDisplay(v.max);var y=c.formatNumberForDisplay(v.min);var r=!e.getValue(this.layout,"Width.minValue.manual",true);var s=!e.getValue(this.layout,"Width.maxValue.manual",true);if(r){y="<"+c.formatNumberForDisplay(this.layout.Width.minValue.value)}if(s){j=">"+c.formatNumberForDisplay(this.layout.Width.maxValue.value)}$("<span>").addClass("data-info-max").html(j).appendTo(x);$("<span>").addClass("data-info-min").html(y).appendTo(x)}}if(this.isVisible()){f.createColorLegend(l,this.layout,t,this.colorSource_,this.colorInfo_)}f.dimLegend(this.id,!this.isVisible());f.fixHeightForLegend(this.id);f.fixWidthForLegend(this.id);$("<div>").addClass("legend-control").appendTo(l);return l};return g});